# 5.3 Flow Mode UI Specification

**Document Purpose:** Complete UI specification for Flow Mode in both SiYuan plugin (Svelte) and Readest integration (React/Next.js), including component breakdown, entity overlay, and design system integration.

**Source Files:**
- `.worktrees/siyuan/ies/plugin/src/views/FlowMode.svelte` (1516 lines)
- `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/FlowPanel.tsx` (197 lines)
- `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/` (all components)
- `.worktrees/siyuan/ies/plugin/src/styles/design-system.scss` (350 lines)
- `.worktrees/readest/readest/apps/readest-app/src/styles/globals.css` (entity overlay styling)

---

## Overview: Three UI Variations

Flow Mode provides **three UI variations** optimized for different exploration patterns:

### 1. Minimalist Mode (SiYuan FlowMode.svelte - Default)

**Purpose:** Focused exploration with minimal visual clutter
**Layout:** Single-column vertical stack
**Components:**
- Search input with entity type filter
- Relationship groups (collapsible)
- Thinking partner questions (expandable)
- Entity details panel

**Use Case:** Deep reading, concept understanding, linear exploration

### 2. Exploratory Mode (Readest FlowPanel.tsx - Default)

**Purpose:** Rich information display during reading
**Layout:** Resizable side panel (280-800px width)
**Components:**
- Entity type filter pills
- Entity header card
- Tabbed sections (Relationships, Sources, Questions, Reframes, Journey)
- Breadcrumb trail

**Use Case:** Active reading with parallel entity lookup

### 3. Node Galaxy Mode (Future Enhancement)

**Purpose:** Spatial graph visualization
**Layout:** Full-screen force-directed graph
**Components:**
- Central node (current entity)
- Orbiting related entities
- Animated relationship lines
- Mini-map for navigation

**Use Case:** Discovering unexpected connections, serendipitous exploration

---

## SiYuan FlowMode.svelte Layout

### Component Hierarchy

```
FlowMode.svelte (1516 lines)
â”œâ”€â”€ Search & Filter Section
â”‚   â”œâ”€â”€ Entity search input (lines 430-438)
â”‚   â”œâ”€â”€ Entity type dropdown (Concept/Person/Theory/Framework/Assessment)
â”‚   â””â”€â”€ "Request Thinking Partner" button (lines 483-485)
â”œâ”€â”€ Results Display
â”‚   â”œâ”€â”€ If search results: Entity cards with type badges (lines 443-464)
â”‚   â”œâ”€â”€ If entity selected: Relationship groups (lines 471-502)
â”‚   â””â”€â”€ Thinking Partner Questions (lines 510-550)
â”œâ”€â”€ Interactive Question-Response Card (lines 560-620)
â”‚   â”œâ”€â”€ Question with class-specific border color
â”‚   â”œâ”€â”€ Expandable hint section (cognitive guidance)
â”‚   â”œâ”€â”€ Textarea for user response
â”‚   â””â”€â”€ Action buttons (Use starter / Skip / Respond)
â””â”€â”€ Question Classes Visual Tracker (lines 528-538)
    â””â”€â”€ Emoji badges showing question types used
```

### Key CSS Classes

**Main container:**
```scss
.flow-mode {
  display: flex;
  flex-direction: column;
  gap: var(--space-4); // 32px
  padding: var(--space-4);
  max-width: 900px;
  margin: 0 auto;
}
```

**Relationship groups:**
```scss
.relationship-group {
  margin-bottom: var(--space-3); // 24px
  border-radius: var(--radius-md); // 8px
  background: var(--bg-elevated);
  box-shadow: var(--shadow-sm);
}

.group-header {
  display: flex;
  justify-content: space-between;
  padding: var(--space-2);
  cursor: pointer;
  user-select: none;

  .relationship-type {
    font-weight: 600;
    color: var(--accent);
  }

  .count-badge {
    background: var(--accent-subtle);
    color: var(--accent);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.875rem;
  }
}
```

**Thinking partner questions:**
```scss
.thinking-questions {
  background: linear-gradient(135deg, var(--accent-subtle) 0%, var(--bg-elevated) 100%);
  border-left: 4px solid var(--accent);
  padding: var(--space-3);
  border-radius: var(--radius-md);
}

.question-class-badges {
  display: flex;
  gap: var(--space-1);
  flex-wrap: wrap;
  margin-top: var(--space-2);
}

.question-class-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-weight: 500;
  background: var(--bg-subtle);

  // Class-specific colors (lines 107-127)
  &.schema-probe { color: #4a90d9; }
  &.boundary { color: #7b68ee; }
  &.dimensional { color: #20b2aa; }
  &.causal { color: #f4a460; }
  &.counterfactual { color: #da70d6; }
  &.anchor { color: #3cb371; }
  &.perspective-shift { color: #cd853f; }
  &.meta-cognitive { color: #778899; }
  &.reflective-synthesis { color: #6495ed; }
}
```

**Interactive question-response card:**
```scss
.question-response-card {
  border-radius: var(--radius-md);
  background: var(--bg-elevated);
  padding: var(--space-3);
  box-shadow: var(--shadow-md);

  // Class-specific colored border (lines 1290-1360)
  &.schema-probe { border-left: 4px solid #4a90d9; }
  &.boundary { border-left: 4px solid #7b68ee; }
  &.dimensional { border-left: 4px solid #20b2aa; }
  &.causal { border-left: 4px solid #f4a460; }
  &.counterfactual { border-left: 4px solid #da70d6; }
  &.anchor { border-left: 4px solid #3cb371; }
  &.perspective-shift { border-left: 4px solid #cd853f; }
  &.meta-cognitive { border-left: 4px solid #778899; }
  &.reflective-synthesis { border-left: 4px solid #6495ed; }

  .qrc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
  }

  .qrc-question {
    font-size: 1rem;
    line-height: 1.6;
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .qrc-hint {
    background: var(--bg-subtle);
    padding: var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-2);

    .hint-label {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: var(--space-1);
    }
  }

  .qrc-input textarea {
    width: 100%;
    min-height: 120px;
    padding: var(--space-2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-family: var(--font-body);
    resize: vertical;

    &:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-color: var(--accent);
    }
  }

  .qrc-actions {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-2);

    .qrc-starter {
      background: var(--bg-subtle);
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
    }

    .qrc-skip {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
    }

    .qrc-respond {
      background: var(--accent);
      color: white;
      border: none;
      font-weight: 600;
    }

    button {
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);

      &:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }
    }
  }
}
```

### ADHD-Friendly Features

1. **Energy-Based Navigation (Dashboard.svelte, lines 267-271)**
   - Energy filters: Low (ðŸ”‹), Medium (âš¡), High (ðŸ”¥)
   - Resonance filters: 8 emotional signals (curious, excited, surprised, moved, disturbed, unclear, connected, validated)
   - Filter buttons with emoji labels for quick recognition

2. **Question Class Hints (FlowMode.svelte, lines 1290-1360)**
   - Expandable cognitive guidance for each question class
   - Example: "Schema-Probe: Try listing the main categories, components, or buckets"
   - Reduces cognitive load by scaffolding thinking

3. **Response Starters (lines 1320-1340)**
   - Optional sentence starters to overcome activation energy
   - Example: "The main parts are...", "This happens because..."
   - Click to populate textarea with starter

4. **Visual Progress Tracking**
   - Question class badges show which cognitive functions were used
   - Relationship group count badges show exploration breadth

---

## Readest FlowPanel.tsx Layout

### Component Hierarchy

```
FlowPanel.tsx (197 lines)
â”œâ”€â”€ Resize Handle (lines 50-58)
â”œâ”€â”€ Overlay (click outside to close)
â”œâ”€â”€ Panel Container (280-800px width)
â”‚   â”œâ”€â”€ FlowPanelHeader (lines 162-168)
â”‚   â”‚   â”œâ”€â”€ "Flow" title with LuWorkflow icon
â”‚   â”‚   â”œâ”€â”€ Pin button (keep open while reading)
â”‚   â”‚   â””â”€â”€ Close button
â”‚   â”œâ”€â”€ EntityTypeFilter (lines 156-159)
â”‚   â”‚   â”œâ”€â”€ Master toggle (ON/OFF with eye icons)
â”‚   â”‚   â”œâ”€â”€ Entity count status
â”‚   â”‚   â””â”€â”€ Type-specific pills (5 types)
â”‚   â”œâ”€â”€ EntitySection (lines 170-175)
â”‚   â”‚   â”œâ”€â”€ Entity name + type badge
â”‚   â”‚   â””â”€â”€ Entity description
â”‚   â”œâ”€â”€ Tabbed Sections
â”‚   â”‚   â”œâ”€â”€ RelationshipsSection (lines 177-182)
â”‚   â”‚   â”œâ”€â”€ SourcesSection (lines 184-189)
â”‚   â”‚   â”œâ”€â”€ QuestionsSection (lines 191-196)
â”‚   â”‚   â”œâ”€â”€ ReframesSection (lines 198-203)
â”‚   â”‚   â””â”€â”€ JourneyBreadcrumb (lines 205-210)
â””â”€â”€ Journey Breadcrumb (bottom)
    â”œâ”€â”€ Last 5 steps with entity names
    â”œâ”€â”€ Dwell time indicators (seconds/minutes)
    â””â”€â”€ Journey marks counter (saved notes)
```

### Key Component Files

**1. FlowPanelHeader.tsx (58 lines)**
```typescript
export function FlowPanelHeader({ onClose, isPinned, onTogglePin }: Props) {
  return (
    <div className="flow-panel-header">
      <div className="flex items-center gap-2">
        <LuWorkflow className="h-5 w-5 text-accent" />
        <h2 className="text-lg font-semibold">Flow</h2>
      </div>
      <div className="flex items-center gap-2">
        <button onClick={onTogglePin} className="pin-btn">
          {isPinned ? <LuPinOff /> : <LuPin />}
        </button>
        <button onClick={onClose} className="close-btn">
          <LuX />
        </button>
      </div>
    </div>
  );
}
```

**2. EntitySection.tsx (53 lines)**
```typescript
export function EntitySection({ entity }: Props) {
  const typeColors = {
    Concept: 'bg-blue-500/10 text-blue-600',
    Person: 'bg-green-500/10 text-green-600',
    Theory: 'bg-purple-500/10 text-purple-600',
    Framework: 'bg-orange-500/10 text-orange-600',
    Assessment: 'bg-red-500/10 text-red-600'
  };

  return (
    <div className="flow-card entity-section">
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-xl font-bold">{entity.name}</h3>
        <span className={`entity-type-badge ${typeColors[entity.type]}`}>
          {entity.type}
        </span>
      </div>
      {entity.description && (
        <p className="text-sm text-gray-600 dark:text-gray-400">
          {entity.description}
        </p>
      )}
    </div>
  );
}
```

**3. RelationshipsSection.tsx (104 lines)**
```typescript
export function RelationshipsSection({ relationships, onNavigate }: Props) {
  // Group relationships by type
  const grouped = relationships.reduce((acc, rel) => {
    const type = rel.relationshipType;
    if (!acc[type]) acc[type] = [];
    acc[type].push(rel);
    return acc;
  }, {} as Record<string, Relationship[]>);

  return (
    <div className="flow-card relationships-section">
      <h4 className="flow-section-header">
        <LuGitBranch className="h-4 w-4" />
        Relationships
      </h4>
      {Object.entries(grouped).map(([type, rels]) => (
        <div key={type} className="relationship-group">
          <div className="group-header">
            <span className="relationship-type">{type}</span>
            <span className="count-badge">{rels.length}</span>
          </div>
          <div className="group-items">
            {rels.map(rel => (
              <button
                key={rel.id}
                onClick={() => onNavigate(rel.targetName)}
                className="relationship-item"
              >
                <span className="entity-name">{rel.targetName}</span>
                {rel.targetType && (
                  <span className={`entity-type-badge ${typeColors[rel.targetType]}`}>
                    {rel.targetType}
                  </span>
                )}
              </button>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}
```

**4. QuestionsSection.tsx (210 lines)**
```typescript
export function QuestionsSection({ questions, onAddJourneyMark }: Props) {
  const [expandedIndex, setExpandedIndex] = useState<number | null>(null);
  const [responses, setResponses] = useState<Record<number, string>>({});
  const [submitted, setSubmitted] = useState<Record<number, boolean>>({});

  const handleSubmit = (index: number, question: string) => {
    const response = responses[index];
    if (!response?.trim()) return;

    // Track in journey
    onAddJourneyMark({
      type: 'question_response',
      question,
      response,
      timestamp: Date.now()
    });

    setSubmitted(prev => ({ ...prev, [index]: true }));
  };

  const handleKeyDown = (e: React.KeyboardEvent, index: number, question: string) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
      e.preventDefault();
      handleSubmit(index, question);
    }
  };

  return (
    <div className="flow-card questions-section">
      <h4 className="flow-section-header">
        <LuHelpCircle className="h-4 w-4" />
        Thinking Partner Questions
      </h4>
      {questions.map((q, idx) => (
        <div key={idx} className="question-item">
          <button
            onClick={() => setExpandedIndex(expandedIndex === idx ? null : idx)}
            className="question-btn"
          >
            <span className="question-text">{q.question}</span>
            <div className="flex items-center gap-2">
              {q.questionType && (
                <span className={`question-type-label ${q.questionType}`}>
                  {q.questionType}
                </span>
              )}
              <LuChevronDown className={expandedIndex === idx ? 'rotate-180' : ''} />
            </div>
          </button>

          {expandedIndex === idx && !submitted[idx] && (
            <div className="question-response-area">
              <textarea
                value={responses[idx] || ''}
                onChange={e => setResponses(prev => ({ ...prev, [idx]: e.target.value }))}
                onKeyDown={e => handleKeyDown(e, idx, q.question)}
                placeholder="Type your response... (Cmd+Enter to submit)"
                className="response-textarea"
                autoFocus
              />
              <div className="response-actions">
                <button onClick={() => onAddJourneyMark({ type: 'bookmark', question: q.question })}>
                  <LuBookmark /> Save as journey mark
                </button>
                <button onClick={() => handleSubmit(idx, q.question)} className="submit-btn">
                  Submit Response
                </button>
              </div>
            </div>
          )}

          {submitted[idx] && (
            <div className="submitted-response">
              <LuCheck className="text-green-600" />
              <p>Response saved to journey</p>
            </div>
          )}
        </div>
      ))}
    </div>
  );
}
```

**5. JourneyBreadcrumb.tsx (98 lines)**
```typescript
export function JourneyBreadcrumb({ journey, onStepClick }: Props) {
  const recentSteps = journey.breadcrumbs.slice(-5); // Last 5 steps
  const overflowCount = journey.breadcrumbs.length - 5;

  const formatDwellTime = (ms: number) => {
    const seconds = Math.floor(ms / 1000);
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    return `${minutes}m`;
  };

  return (
    <div className="journey-breadcrumb">
      <div className="breadcrumb-header">
        <LuRoute className="h-4 w-4" />
        <span>Journey Path</span>
        {journey.journeyMarks.length > 0 && (
          <span className="journey-marks-count">
            <LuBookmark className="h-3 w-3" />
            {journey.journeyMarks.length} saved
          </span>
        )}
      </div>

      <div className="breadcrumb-trail">
        {overflowCount > 0 && (
          <span className="overflow-indicator">+{overflowCount} more</span>
        )}
        {recentSteps.map((step, idx) => (
          <React.Fragment key={step.timestamp}>
            {idx > 0 && <LuChevronRight className="breadcrumb-separator" />}
            <button
              onClick={() => onStepClick(step.entityName)}
              className="breadcrumb-step"
            >
              <span className="step-name">{step.entityName}</span>
              <span className="step-dwell">
                <LuClock className="h-3 w-3" />
                {formatDwellTime(step.dwellTime)}
              </span>
            </button>
          </React.Fragment>
        ))}
      </div>
    </div>
  );
}
```

**6. EntityTypeFilter.tsx (122 lines - Dec 4 redesign)**
```typescript
export function EntityTypeFilter({
  overlayEnabled,
  onToggleOverlay,
  visibleTypes,
  onToggleType,
  entityCount,
  isLoading,
  error
}: Props) {
  const entityTypes = [
    { type: 'Concept', color: '#2563eb', label: 'Concepts' },
    { type: 'Person', color: '#059669', label: 'People' },
    { type: 'Theory', color: '#7c3aed', label: 'Theories' },
    { type: 'Framework', color: '#ea580c', label: 'Frameworks' },
    { type: 'Assessment', color: '#dc2626', label: 'Assessments' }
  ];

  return (
    <div className="entity-filter-container">
      {/* Master toggle */}
      <button
        onClick={onToggleOverlay}
        className="flow-master-toggle"
      >
        {overlayEnabled ? <LuEye /> : <LuEyeOff />}
        <span>{overlayEnabled ? 'ON' : 'OFF'}</span>
      </button>

      {/* Status indicator */}
      <div className="entity-count-status">
        {isLoading && <LuLoader className="animate-spin" />}
        {error && <span className="text-red-600">{error}</span>}
        {!isLoading && !error && entityCount >= 0 && (
          <span>{entityCount} entities in this book</span>
        )}
        {!isLoading && !error && entityCount === -1 && (
          <span className="text-gray-500">Book not indexed</span>
        )}
      </div>

      {/* Type pills */}
      <div className="entity-type-pills">
        {entityTypes.map(({ type, color, label }) => (
          <button
            key={type}
            onClick={() => overlayEnabled && onToggleType(type)}
            disabled={!overlayEnabled}
            className={`entity-type-pill ${visibleTypes.has(type) ? 'active' : ''}`}
            style={{
              '--pill-color': color,
              '--pill-bg': visibleTypes.has(type) ? `${color}1F` : 'transparent'
            } as React.CSSProperties}
          >
            {label}
          </button>
        ))}
      </div>
    </div>
  );
}
```

### CSS Styling System (globals.css)

**Entity overlay filter controls (lines 559-618):**
```css
.entity-filter-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: var(--bg-elevated);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
}

.flow-master-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: all 200ms;
}

.flow-master-toggle:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.entity-count-status {
  text-align: center;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.entity-type-pills {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.entity-type-pill {
  padding: 6px 12px;
  border-radius: 16px;
  font-size: 0.875rem;
  font-weight: 500;
  border: 1px solid var(--border-light);
  background: var(--pill-bg);
  color: var(--pill-color);
  cursor: pointer;
  transition: all 200ms;
}

.entity-type-pill:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.entity-type-pill.active {
  border-color: var(--pill-color);
  background: var(--pill-bg);
}

.entity-type-pill:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
```

**Inline entity highlights (lines 756-855):**
```css
.entity-concept {
  background: rgba(37, 99, 235, 0.12); /* Blue */
  color: #2563eb;
  padding: 2px 4px;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 200ms;
}

.entity-concept:hover {
  background: rgba(37, 99, 235, 0.2);
  text-decoration: underline;
  text-decoration-color: #2563eb;
}

.entity-person {
  background: rgba(5, 150, 105, 0.12); /* Green */
  color: #059669;
  padding: 2px 4px;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 200ms;
}

.entity-person:hover {
  background: rgba(5, 150, 105, 0.2);
  text-decoration: underline;
  text-decoration-color: #059669;
}

.entity-theory {
  background: rgba(124, 58, 237, 0.12); /* Purple */
  color: #7c3aed;
  padding: 2px 4px;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 200ms;
}

.entity-theory:hover {
  background: rgba(124, 58, 237, 0.2);
  text-decoration: underline;
  text-decoration-color: #7c3aed;
}

.entity-framework {
  background: rgba(234, 88, 12, 0.12); /* Orange */
  color: #ea580c;
  padding: 2px 4px;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 200ms;
}

.entity-framework:hover {
  background: rgba(234, 88, 12, 0.2);
  text-decoration: underline;
  text-decoration-color: #ea580c;
}

.entity-assessment {
  background: rgba(220, 38, 38, 0.12); /* Red */
  color: #dc2626;
  padding: 2px 4px;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 200ms;
}

.entity-assessment:hover {
  background: rgba(220, 38, 38, 0.2);
  text-decoration: underline;
  text-decoration-color: #dc2626;
}
```

---

## Entity Overlay: Click-to-Flow Interaction

### Trie-Based Entity Matching (entity.ts, 204 lines)

**Problem:** Regex alternations `(entity1|entity2|...)` cause catastrophic backtracking with 100+ entities (5-10 second browser freezes).

**Solution:** Trie-based token matching with O(n) linear performance.

**Implementation:**

```typescript
interface TrieNode {
  children: Map<string, TrieNode>;
  isEnd: boolean;
  entityName?: string;
}

function buildEntityTrie(entities: Entity[]): TrieNode {
  const root: TrieNode = { children: new Map(), isEnd: false };

  for (const entity of entities) {
    const tokens = entity.name.toLowerCase().split(/\s+/);
    let current = root;

    for (const token of tokens) {
      if (!current.children.has(token)) {
        current.children.set(token, { children: new Map(), isEnd: false });
      }
      current = current.children.get(token)!;
    }

    current.isEnd = true;
    current.entityName = entity.name;
  }

  return root;
}

function processTextWithTrie(text: string, trie: TrieNode, visibleTypes: Set<string>): string {
  const tokens = text.split(/(\s+)/); // Preserve whitespace
  const result: string[] = [];
  let i = 0;

  while (i < tokens.length) {
    if (/^\s+$/.test(tokens[i])) {
      result.push(tokens[i]); // Preserve whitespace
      i++;
      continue;
    }

    // Try to match entity phrase starting at current position
    let current = trie;
    let matchEnd = -1;
    let matchedEntity = '';

    for (let j = i; j < tokens.length; j += 2) { // Skip whitespace tokens
      const tokenLower = tokens[j].toLowerCase();
      if (!current.children.has(tokenLower)) break;

      current = current.children.get(tokenLower)!;
      if (current.isEnd) {
        matchEnd = j;
        matchedEntity = current.entityName!;
      }
    }

    if (matchEnd !== -1) {
      // Found entity match
      const entityType = getEntityType(matchedEntity);
      if (visibleTypes.has(entityType)) {
        const phrase = tokens.slice(i, matchEnd + 1).join('');
        result.push(wrapEntity(phrase, entityType));
      } else {
        result.push(...tokens.slice(i, matchEnd + 1));
      }
      i = matchEnd + 1;
    } else {
      result.push(tokens[i]);
      i++;
    }
  }

  return result.join('');
}

function wrapEntity(text: string, type: string): string {
  const className = `entity-${type.toLowerCase()}`;
  return `<span class="${className}" data-entity="${text}">${text}</span>`;
}
```

**Performance:**
- **Before (regex):** O(n*m) catastrophic backtracking, 5-10 second hangs
- **After (trie):** O(n) linear scan, <100ms for 100+ entities
- **Multi-word support:** "executive function", "cognitive behavioral therapy"
- **Longest match preference:** Trie prioritizes longer entity names when overlapping

### Event Flow: Text Highlight â†’ Flow Panel

1. **Book loads:** FoliateViewer fetches entities via `fetchEntitiesForBook(book.hash, book.title)`
2. **Trie built:** `buildEntityTrie()` creates case-insensitive trie from entity names
3. **HTML transformed:** `processTextWithTrie()` wraps entity names in styled `<span>` elements
4. **User clicks entity:** Event dispatched from iframe content
5. **useEntityClick hook:** Listens for `entity-click` events (useEntityClick.ts, 88 lines)
6. **Flow panel opens:** `setCurrentEntity(entityName)` in flowModeStore
7. **Entity fetched:** `searchEntity(entityName)` calls `/graph/entities/search?q={name}`
8. **Journey updated:** `addJourneyStep({ entityName, timestamp, dwellTime })`
9. **Panel renders:** EntitySection, RelationshipsSection, SourcesSection, QuestionsSection populate

**Critical bug fixes:**
- **BUG-R01 (Memory leak):** iframeDocsRef Map tracks all iframe documents + event listeners, cleanup in useEffect
- **BUG-R02 (Regex bomb):** Trie-based matching eliminates catastrophic backtracking
- **BUG-R03 (AbortController):** Fetch requests aborted on component unmount to prevent memory leaks

---

## IES Design System Integration

### Typography (4-font system)

```css
--font-display: 'Crimson Pro', Georgia, serif;      /* 28px/34px headings */
--font-body: 'Nunito', 'Segoe UI', sans-serif;      /* 15px/24px reading */
--font-ui: 'Inter', system-ui, sans-serif;          /* 14px/20px controls */
--font-mono: 'JetBrains Mono', 'Courier New', mono; /* 13px/20px code */
```

**Major Third Scale (1.25 ratio, 15px base):**
- xs: 0.64rem (9.6px) â€” Footnotes, metadata
- sm: 0.8rem (12px) â€” Captions, labels
- base: 1rem (15px) â€” Body text
- md: 1.25rem (18.75px) â€” Subheadings
- lg: 1.563rem (23.44px) â€” Section headers
- xl: 1.953rem (29.3px) â€” Page titles
- 2xl: 2.441rem (36.62px) â€” Display

### Colors (Contemplative Knowledge Space)

**Base palette:**
```css
--paper-deep: #f8f6f3;      /* Deep warm paper */
--paper-base: #fffef9;      /* Base paper tone */
--paper-bright: #ffffff;    /* Pure white for contrast */
--ink-base: #2b2621;        /* Warm charcoal */
--ink-subtle: #5a544d;      /* Subdued ink */
--accent: #d4a574;          /* Amber accent */
--secondary: #7a9987;       /* Sage secondary */
--tertiary: #9d8fb5;        /* Soft violet */
```

**Entity type colors:**
```css
--entity-concept: #2563eb;     /* Blue */
--entity-person: #059669;      /* Green */
--entity-theory: #7c3aed;      /* Purple */
--entity-framework: #ea580c;   /* Orange */
--entity-assessment: #dc2626;  /* Red */
```

### Spacing (8px base unit)

```css
--space-0: 0px;
--space-1: 8px;   /* Tight spacing */
--space-2: 16px;  /* Standard gap */
--space-3: 24px;  /* Section spacing */
--space-4: 32px;  /* Container padding */
--space-5: 40px;  /* Large gaps */
--space-6: 48px;  /* Page margins */
--space-8: 64px;  /* Generous space */
--space-10: 80px; /* Hero spacing */
--space-12: 96px; /* Maximum spacing */
```

### Shadows (6-level elevation)

```css
--shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
--shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
--shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
--shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.12);
--shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.15);
--shadow-glow: 0 0 20px rgba(212, 165, 116, 0.2); /* Amber glow */
```

### Animations (4 durations)

```css
--transition-instant: 100ms;
--transition-fast: 200ms;
--transition-base: 300ms;
--transition-slow: 500ms;

/* Easing */
--ease-out: cubic-bezier(0.33, 1, 0.68, 1);
--ease-in-out: cubic-bezier(0.65, 0, 0.35, 1);
```

**Staggered animations:**
```css
@keyframes ies-stagger {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.flow-card {
  animation: ies-stagger var(--transition-base) var(--ease-out);
}

.flow-card:nth-child(1) { animation-delay: 0ms; }
.flow-card:nth-child(2) { animation-delay: 40ms; }
.flow-card:nth-child(3) { animation-delay: 80ms; }
.flow-card:nth-child(4) { animation-delay: 120ms; }
```

---

## Summary

### Three UI Variations
- **Minimalist (SiYuan):** Single-column, focused exploration, relationship groups
- **Exploratory (Readest):** Resizable panel, tabbed sections, rich information display
- **Node Galaxy (Future):** Force-directed graph, spatial visualization

### Component Breakdown (Readest)
- **FlowPanelHeader:** Title, pin button, close button
- **EntityTypeFilter:** Master toggle, entity count, type pills
- **EntitySection:** Entity name + type badge + description
- **RelationshipsSection:** Grouped relationships with count badges
- **SourcesSection:** Book citations with chapter/page info
- **QuestionsSection:** Expandable questions with response capture (Cmd+Enter)
- **JourneyBreadcrumb:** Last 5 steps, dwell time, journey marks counter

### Entity Overlay System
- **Trie-based matching:** O(n) linear performance, multi-word support
- **Type-specific highlighting:** 5 colors (Concept/Person/Theory/Framework/Assessment)
- **Click-to-flow:** Event dispatch â†’ hook listener â†’ panel render
- **Journey tracking:** Breadcrumb steps with dwell time calculation

### IES Design System Integration
- **Typography:** 4-font system (Crimson Pro, Nunito, Inter, JetBrains Mono)
- **Spacing:** 8px base unit, 11-step scale
- **Shadows:** 6-level elevation system
- **Animations:** Staggered reveals with 40ms delays

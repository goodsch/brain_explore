# 5.2 Project AST Maps

**Document Purpose:** Define project decomposition visualization using AST (Abstract Syntax Tree) maps for structured project planning and tracking.

**Source Files:**
- `.worktrees/siyuan/ies/plugin/src/types/blocks.ts` — DecisionBlockMeta interface (lines 185-195)
- `.worktrees/siyuan/ies/plugin/src/utils/siyuan-structure.ts` — Projects folder structure (line 88)
- `docs/IES_SiYuan_Architecture/05_Projects/README.md` — Project structure specification
- `docs/IES_SiYuan_Architecture/07_System/Templates/Template_Project_Structure.md` — 8-page project template

---

## What is a Project AST Map?

An **AST (Abstract Syntax Tree) map** for projects is a **visual decomposition** of project structure, showing:
- Goal hierarchy (root node → subgoals → tasks)
- Decision points and their rationale
- Subsystems and dependencies
- Data flows between components
- Tasks and execution order

Unlike code ASTs, project ASTs map **conceptual structure** rather than syntax. They provide a **spatial representation** of how a project decomposes from high-level goals to concrete tasks.

**Purpose:**
- **Planning:** Visualize project structure before implementation
- **Communication:** Share project architecture with collaborators
- **Decision tracking:** Document why choices were made
- **Dependency management:** Identify bottlenecks and critical paths

---

## Project AST vs. Flow Maps

| Dimension | Project AST | Flow Map (03_Flow_Maps) |
|-----------|-------------|-------------------------|
| **Purpose** | Decompose goals → tasks | Explore concept relationships |
| **Structure** | Hierarchical tree | Network graph |
| **Nodes** | Goals, Decisions, Tasks | Concepts, Entities, Questions |
| **Edges** | Dependencies, Phases | Semantic relationships |
| **Lifecycle** | Created during planning, updated during execution | Emergent during exploration |
| **Location** | `/Projects/{project}/Maps.md` | `/Flow_Maps/` |

---

## Project Decomposition Elements

### 1. Goal Tree

Root goal breaks into subgoals, which break into concrete tasks.

```mermaid
graph TD
    G1[Build ADHD-Friendly Knowledge System]
    G1 --> G2[Layer 1: Knowledge Graph]
    G1 --> G3[Layer 2: Backend APIs]
    G1 --> G4[Layer 3: SiYuan Plugin]
    G2 --> T1[Ingest books from Calibre]
    G2 --> T2[Extract entities with OpenAI]
    G3 --> T3[Reframe API endpoint]
    G3 --> T4[Personal Graph API]
    G4 --> T5[ForgeMode UI]
    G4 --> T6[Dashboard with energy filters]
```

**Node Types:**
- **Goal nodes** (rectangles): High-level outcomes
- **Subgoal nodes** (rounded): Intermediate objectives
- **Task nodes** (circles): Concrete actions

### 2. Decision Points

Critical architectural choices with rationale.

```mermaid
graph LR
    D1{{Use Neo4j or PostgreSQL?}}
    D1 -->|ACCEPTED| N[Neo4j]
    D1 -.->|REJECTED| P[PostgreSQL]
    N --> R1[Rationale: Native graph traversal]
    N --> R2[Relationships are first-class]
    P -.-> R3[Rationale: Simpler ops]
```

**Decision Schema (DecisionBlockMeta):**
```typescript
{
  block_type: 'decision',
  project_id: string,
  decision_status: 'pending' | 'accepted' | 'rejected' | 'revisited',
  rationale?: string,
  decided_at?: string,
  related_maps?: string[],
  related_concepts?: string[]
}
```

### 3. Subsystems and Components

Major architectural modules with internal structure.

```mermaid
graph TD
    subgraph Backend
        A[FastAPI Server]
        B[GraphService]
        C[Neo4j Client]
    end
    subgraph Frontend
        D[SiYuan Plugin]
        E[Readest Integration]
    end
    A --> B
    B --> C
    D --> A
    E --> A
```

### 4. Data Flows

How information moves through the system.

```mermaid
graph LR
    A[User highlights text] --> B[Readest captures]
    B --> C[Backend /personal/sparks]
    C --> D[Neo4j Personal Graph]
    D --> E[SiYuan Dashboard]
    E --> F[Energy-based navigation]
```

### 5. Tasks and Dependencies

Execution order with critical paths.

```mermaid
graph TD
    T1[Design API schemas] --> T2[Implement GraphService]
    T1 --> T3[Implement PersonalService]
    T2 --> T4[Write backend tests]
    T3 --> T4
    T4 --> T5[Build SiYuan Dashboard]
    T4 --> T6[Build Readest Flow Panel]
    T5 --> T7[Integration testing]
    T6 --> T7
```

---

## Integration with /Projects/ Folder

Each project in `/Projects/` has an **8-page structure** (Template_Project_Structure.md):

| Page | AST Element | Purpose |
|------|-------------|---------|
| **README.md** | Project overview | Links to key maps and concepts |
| **Goals.md** | Goal tree | Outcomes, constraints, success criteria |
| **Questions.md** | Open questions | Unknowns, hypotheses |
| **Research.md** | References | Links to Seedlings and Concept pages |
| **Maps.md** | AST maps | Visual decomposition (THIS DOCUMENT) |
| **Decisions.md** | Decision nodes | Status, rationale, decision-blocks |
| **Plan.md** | Task graph | High-level roadmap, phases, milestones |
| **Status.md** | Current state | Recently completed, risks, blockers |
| **Logs.md** | Execution log | Chronological log-entry-blocks |

**Maps.md** contains project AST visualizations, stored as:
- Mermaid diagrams (text-based, version-controllable)
- Links to `/03_Flow_Maps/` for concept exploration
- Embedded diagrams showing goal decomposition
- Decision trees with rationale

---

## Template for Creating Project AST Maps

### Step 1: Define Root Goal

```markdown
# Project AST: [Project Name]

**Root Goal:** [Single sentence describing project outcome]

**Success Criteria:**
- [Measurable outcome 1]
- [Measurable outcome 2]
- [Measurable outcome 3]
```

### Step 2: Decompose into Subgoals

```mermaid
graph TD
    Root[Root Goal] --> SG1[Subgoal 1]
    Root --> SG2[Subgoal 2]
    Root --> SG3[Subgoal 3]
```

### Step 3: Add Tasks and Dependencies

```mermaid
graph TD
    SG1[Subgoal 1] --> T1[Task 1.1]
    SG1 --> T2[Task 1.2]
    T1 --> T3[Task 1.3]
    T2 --> T3
```

### Step 4: Document Decision Points

```markdown
## Critical Decisions

### Decision: [Decision description]
- **Status:** [pending/accepted/rejected]
- **Rationale:** [Why this choice?]
- **Decided:** [Date]
- **Related:** [[concept-page]], [[map-page]]
```

### Step 5: Add System Diagram (if applicable)

```mermaid
graph LR
    subgraph System A
        A1[Component 1]
        A2[Component 2]
    end
    subgraph System B
        B1[Component 3]
    end
    A1 --> B1
```

---

## Example: brain_explore Project AST

```mermaid
graph TD
    Root[Build ADHD-Friendly IES]
    Root --> L1[Layer 1: Knowledge Graph]
    Root --> L2[Layer 2: Backend]
    Root --> L3[Layer 3: SiYuan Plugin]
    Root --> L4[Layer 4: Readest]

    L1 --> L1T1[Calibre integration]
    L1 --> L1T2[Entity extraction pipeline]
    L1 --> L1T3[Auto-ingestion daemon]

    L2 --> L2T1[Reframe API]
    L2 --> L2T2[Personal Graph API]
    L2 --> L2T3[Template API]
    L2 --> L2T4[Question Engine]

    L3 --> L3T1[ForgeMode with templates]
    L3 --> L3T2[Dashboard with energy nav]
    L3 --> L3T3[Quick Capture system]
    L3 --> L3T4[Concept Extractor]

    L4 --> L4T1[Entity overlay]
    L4 --> L4T2[Flow Panel components]
    L4 --> L4T3[Journey breadcrumbs]
    L4 --> L4T4[Calibre Library browser]

    style Root fill:#d4a574
    style L1 fill:#2563eb
    style L2 fill:#059669
    style L3 fill:#7c3aed
    style L4 fill:#ea580c
```

**Key Decisions:**
- Use Neo4j for graph (ACCEPTED): Native relationship traversal
- Dual status systems (ACCEPTED): AI processing vs. user engagement
- Calibre as single source of truth (ACCEPTED): Eliminates hash/title matching fragility

---

## Mermaid Examples for Common Project Structures

### Research Project

```mermaid
graph TD
    Research[Research Question] --> Lit[Literature Review]
    Research --> Data[Data Collection]
    Research --> Analysis[Analysis]

    Lit --> Synthesis[Synthesis]
    Data --> Synthesis
    Analysis --> Synthesis

    Synthesis --> Paper[Write Paper]
    Synthesis --> Presentation[Create Presentation]
```

### Product Development

```mermaid
graph TD
    Product[Product Vision] --> MVP[MVP Scope]

    MVP --> Design[Design Phase]
    MVP --> Backend[Backend Phase]
    MVP --> Frontend[Frontend Phase]

    Design --> D1[Wireframes]
    Design --> D2[User flows]

    Backend --> B1[API design]
    Backend --> B2[Database schema]
    Backend --> B3[Auth system]

    Frontend --> F1[Component library]
    Frontend --> F2[State management]
    Frontend --> F3[UI polish]

    D1 --> Integration
    D2 --> Integration
    B1 --> Integration
    B2 --> Integration
    B3 --> Integration
    F1 --> Integration
    F2 --> Integration
    F3 --> Integration

    Integration[Integration Testing] --> Launch[Launch]
```

### Learning Project

```mermaid
graph TD
    Learn[Master React Hooks] --> Understand[Understand Concepts]
    Learn --> Practice[Build Projects]

    Understand --> U1[useState]
    Understand --> U2[useEffect]
    Understand --> U3[Custom hooks]

    Practice --> P1[Todo app]
    Practice --> P2[Weather dashboard]
    Practice --> P3[Chat interface]

    U1 --> P1
    U2 --> P1
    U2 --> P2
    U3 --> P2
    U3 --> P3

    P1 --> Review[Code Review]
    P2 --> Review
    P3 --> Review

    Review --> Portfolio[Add to Portfolio]
```

---

## Integration with Dialogue Mode

**AST maps support Planning mode in ForgeMode:**

1. **Mode Selection:** User selects "Planning" mode in ForgeMode
2. **Template Loaded:** `planning-project-structure` template (future implementation)
3. **Section 1: Goal Definition** — AI prompts for root goal and success criteria
4. **Section 2: Goal Decomposition** — AI generates goal tree visualization
5. **Section 3: Task Identification** — AI helps break subgoals into tasks
6. **Section 4: Dependency Analysis** — AI identifies critical paths
7. **Section 5: Decision Documentation** — AI prompts for key architectural choices
8. **Output:** AST map saved to `/Projects/{project}/Maps.md`

**Thinking Partner Questions (Planning Mode):**
- **Schema-Probe:** "What are the main subsystems of this project?"
- **Boundary:** "What's explicitly NOT in scope for this phase?"
- **Dimensional:** "On a spectrum from research to execution, where is this?"
- **Causal:** "What has to happen before X can start?"
- **Counterfactual:** "What if the critical dependency doesn't ship on time?"

---

## Design Rationale

**Why AST Maps for Projects?**
- **Visual clarity:** Spatial representation easier to understand than text lists
- **Dependency tracking:** Critical paths immediately visible
- **Decision documentation:** Rationale preserved in context
- **Mermaid format:** Text-based, version-controllable, renders in SiYuan
- **ADHD-friendly:** Hierarchical structure reduces cognitive load

**Why separate from Flow Maps?**
- Flow maps are **emergent** during exploration (discovery-driven)
- Project ASTs are **deliberate** during planning (goal-driven)
- Different thinking modes require different visualizations

---

## Summary

- **Project AST maps** visualize project structure from goals to tasks
- **5 decomposition elements:** Goal tree, Decision points, Subsystems, Data flows, Tasks/dependencies
- **Integration:** Maps.md in `/Projects/` folder stores AST diagrams
- **Template:** 5-step process for creating project ASTs (goal → subgoals → tasks → decisions → systems)
- **Mermaid examples:** Research, Product, Learning project structures
- **Dialogue integration:** Planning mode generates AST maps interactively

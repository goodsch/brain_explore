# 3.4 Entity Graph Schema

**Purpose:** The IES knowledge graph uses Neo4j to store two parallel graph systems: (1) Domain Knowledge from books/research, and (2) Personal Knowledge from ADHD-friendly capture workflows. Both systems share a common graph database but use different node types and relationship patterns.

## Two Knowledge Graph Systems

### System 1: Domain Knowledge Graph (Books/Research)

**Purpose:** Structured knowledge from ingested books and research papers

**Client:** `library/graph/neo4j_client.py` (`KnowledgeGraph` class)

**Node Types:**

From `library/graph/neo4j_client.py` (lines 3-20):

```python
Schema:
- (:Researcher {name, description})
- (:Concept {name, description, aliases})
- (:Theory {name, description, aliases})
- (:Assessment {name, description, aliases})
- (:Book {title, author, path, calibre_id, processing_status})
- (:Chunk {id, content})
```

**Relationships:**

```python
Relationships:
- (Researcher)-[:CITES]->(Researcher)
- (Researcher)-[:DEVELOPS]->(Theory|Concept)
- (Chunk)-[:SUPPORTS]->(Concept|Theory)
- (Chunk)-[:CONTRADICTS]->(Concept|Theory)
- (Assessment)-[:OPERATIONALIZES]->(Concept)
- (Concept)-[:COMPONENT_OF]->(Theory|Concept)
- (Chunk)-[:FROM_BOOK]->(Book)
- (Chunk)-[:MENTIONS]->(Entity)
```

### System 2: Personal Knowledge Graph (ADHD-Friendly)

**Purpose:** Personal thinking artifacts captured during exploration/reading

**Client:** `library/graph/adhd_graph_client.py` (`ADHDKnowledgeGraph` class)

**Node Types:**

From `library/graph/adhd_ontology.py`:

```python
class EntityType(str, Enum):
    SPARK = "spark"              # Raw resonance capture
    INSIGHT = "insight"          # Processed meaning
    THREAD = "thread"            # Exploration path
    FAVORITE_PROBLEM = "favorite_problem"  # Anchor question
    CONCEPT = "concept"          # Canonical concept (shared with Domain Graph)
```

**Additional Node Types (Backend Schemas):**

From `ies/backend/src/ies_backend/schemas/`:

- `CaptureItem` (capture.py): Quick Capture queue item
- `ThinkingSession` (thinking.py): Structured thinking session
- `FlowSession` (flow_session.py): Flow mode exploration session

**Relationships:**

From `library/graph/adhd_ontology.py`:

```python
class RelationshipType(str, Enum):
    # Discovery flow
    SPARKED_BY = "sparked_by"
    LED_TO_DISCOVERY = "led_to_discovery"
    ADDRESSES_PROBLEM = "addresses_problem"
    
    # Energy mapping
    ENERGY_TOWARD = "energy_toward"  # Feels generative
    ENERGY_AWAY = "energy_away"      # Feels draining
    
    # Standard relationships (shared with Domain Graph)
    SUPPORTS = "supports"
    CONTRADICTS = "contradicts"
    DEVELOPS = "develops"
    COMPONENT_OF = "component_of"
```

## Domain Graph Node Schemas

### Book Node

**Properties:**

| Property | Type | Purpose | Example |
|----------|------|---------|---------|
| `calibre_id` | `int` | Primary identifier (Calibre book ID) | `42` |
| `title` | `string` | Book title | `"Taking Charge of ADHD"` |
| `author` | `string` | Author name | `"Russell Barkley"` |
| `path` | `string` | File path in Calibre library | `"/calibre-library/Barkley, Russell/Taking Charge..."` |
| `processing_status` | `string` | Ingestion pipeline status | `"entities_extracted"` |
| `has_entities` | `boolean` | Whether entities have been extracted | `true` |

**Status Lifecycle:**

```
pending → chunked → entities_extracted → relationships_mapped → enriched
```

**Created by:** Calibre ingestion pipeline (`scripts/ingest_calibre.py`)

### Entity Nodes (Concept, Theory, Framework, etc.)

**Labels:** Dynamic based on entity type (Concept, Theory, Framework, Mechanism, Phenomenon, Pattern, Distinction, Person, Assessment)

**Properties:**

| Property | Type | Purpose | Example |
|----------|------|---------|---------|
| `id` | `string` | Unique identifier | `"concept_abc123"` |
| `name` | `string` | Entity name (unique constraint) | `"Executive Function"` |
| `description` | `string` | Definition/explanation | `"The set of cognitive processes..."` |
| `aliases` | `string[]` | Alternative names | `["EF", "Cognitive Control"]` |
| `domain` | `string?` | Domain context | `"neuroscience"` |
| `energy_level` | `string?` | ADHD navigation | `"high"` |

**Relationships:**

Entities connect via typed relationships:
- `(Concept)-[:SUPPORTS]->(Theory)`: Concept provides evidence for theory
- `(Concept)-[:CONTRADICTS]->(Concept)`: Concepts in tension
- `(Concept)-[:COMPONENT_OF]->(Theory)`: Part-whole relationships
- `(Assessment)-[:OPERATIONALIZES]->(Concept)`: Assessment measures concept
- `(Concept)-[:DEVELOPS]->(Concept)`: One concept extends another

**Evidence Metadata:**

All relationships can include `evidence` property:

```cypher
(source)-[r:SUPPORTS]->(target)
SET r.evidence = "Quote or explanation supporting this relationship"
```

**Created by:** Entity extraction pipeline + manual concept formalization

### Chunk Node

**Purpose:** Text segments from books that mention entities

**Properties:**

| Property | Type | Purpose | Example |
|----------|------|---------|---------|
| `id` | `string` | Unique chunk identifier | `"chunk_book42_001"` |
| `content` | `string` | Text content (truncated to 500 chars in DB) | `"Executive function deficits are..."` |

**Relationships:**
- `(Chunk)-[:FROM_BOOK]->(Book)`: Links chunk to source book
- `(Chunk)-[:MENTIONS]->(Entity)`: Chunk contains reference to entity

**Created by:** Chunking step in ingestion pipeline

## Personal Graph Node Schemas

### Spark Node

**Purpose:** Raw capture of resonant moment (low-friction, unprocessed)

**Properties:**

From `library/graph/adhd_graph_client.py` (lines 156-172):

| Property | Type | Purpose | Example |
|----------|------|---------|---------|
| `id` | `string` | Unique identifier | `"spark_abc123"` |
| `title` | `string` | Short title | `"Shame blocks EF access?"` |
| `content` | `string` | Full content | `"Reading Barkley - realized..."` |
| `resonance_signal` | `enum?` | Emotional retrieval cue | `"curiosity"` |
| `capture_context` | `string?` | Where captured | `"Reading session"` |
| `energy_level` | `enum` | Mood state | `"medium"` |
| `status` | `enum` | User engagement | `"captured"` |
| `source_id` | `string?` | Link to domain entity | `"concept_xyz789"` |
| `source_location` | `string?` | Location in source | `"Chapter 3, pg 42"` |
| `tags` | `string[]` | User tags | `["adhd", "shame"]` |
| `exploration_visits` | `int` | Visit counter | `3` |
| `created_at` | `datetime` | Capture timestamp | `"2025-12-05T10:30:00Z"` |
| `schema_version` | `string` | Schema version | `"0.1.0"` |

**Resonance Signals (8 types):**

From `library/graph/adhd_ontology.py`:

```python
class ResonanceSignal(str, Enum):
    CURIOUS = "curious"
    EXCITED = "excited"
    SURPRISED = "surprised"
    MOVED = "moved"
    DISTURBED = "disturbed"
    UNCLEAR = "unclear"
    CONNECTED = "connected"
    VALIDATED = "validated"
```

**Energy Levels:**

```python
class EnergyLevel(str, Enum):
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
```

**Created by:** `capture_spark()` in `adhd_graph_client.py` (lines 136-187)

### Insight Node

**Purpose:** Processed meaning extracted from sparks or sessions

**Properties:** Similar to Spark, with additional fields for formalization

| Property | Type | Purpose |
|----------|------|---------|
| All Spark fields | ... | Inherits from Spark |
| `source_spark_id` | `string?` | Link to originating spark |
| `validation_notes` | `string?` | Why this insight is valuable |

**Created by:** Promoting spark via `promote_spark_to_insight()` in `adhd_graph_client.py`

### CaptureItem Node (Backend)

**Purpose:** Queue item for Quick Capture processing

**Properties:**

From `ies/backend/src/ies_backend/schemas/capture.py` (lines 176-203):

| Property | Type | Purpose | Example |
|----------|------|---------|---------|
| `id` | `string` | Unique ID | `"capture_123"` |
| `raw_text` | `string` | Captured text | `"Flow doesn't start from zero..."` |
| `source` | `enum` | Capture source | `"assistant-interruption"` |
| `captured_at` | `datetime` | Timestamp | `"2025-12-05T10:30:00Z"` |
| `status` | `enum` | Processing state | `"queued"` |
| `context_snippet` | `string?` | Context | `"During architecture discussion"` |
| `auto_extracted` | `object?` | AI metadata | `{entities: [...], topics: [...]}` |
| `spark` | `object?` | Spark details | Nested Spark object |

**Status Values:**
- `queued`: Waiting for processing
- `in_thinking`: User is exploring in Thinking Session
- `integrated`: Formalized into knowledge graph

**Created by:** Backend CaptureService (`ies/backend/src/ies_backend/services/capture_service.py`)

### ThinkingSession Node (Backend)

**Purpose:** Structured thinking session state

**Properties:**

From `ies/backend/src/ies_backend/schemas/thinking.py` (lines 39-51):

| Property | Type | Purpose | Example |
|----------|------|---------|---------|
| `id` | `string` | Session ID | `"session_abc123"` |
| `capture_id` | `string` | Originating capture | `"capture_123"` |
| `created_at` | `datetime` | Start time | `"2025-12-05T10:30:00Z"` |
| `status` | `enum` | Session state | `"active"` |
| `siyuan_note_id` | `string?` | Linked SiYuan doc | `"20251205103000-abc123"` |
| `angles` | `array` | Exploration angles | `[{id, title, description}]` |
| `entities` | `string[]` | Extracted entities | `["Executive Function", "Shame"]` |
| `breadcrumbs` | `array` | Journey steps | Breadcrumb objects |

**Breadcrumb Structure:**

```python
class Breadcrumb(BaseModel):
    id: str
    timestamp: datetime
    node_id: str | None
    edge_id: str | None
    from_spark: str | None
    user_note: str | None
    summary: str | None
    angle_id: str | None
```

**Created by:** Backend ThinkingService (`ies/backend/src/ies_backend/services/thinking_service.py`)

### FlowSession Node (Backend)

**Purpose:** Flow mode exploration session

**Properties:**

From `ies/backend/src/ies_backend/schemas/flow_session.py` (lines 63-73):

| Property | Type | Purpose |
|----------|------|---------|
| `id` | `string` | Session ID |
| `origin` | `object` | Entry point (thinking session, spark, or concept) |
| `visited_nodes` | `string[]` | Nodes explored during session |
| `visited_edges` | `string[]` | Relationships traversed |
| `breadcrumbs` | `array` | Journey steps |
| `insights` | `string[]` | Discoveries made |

**Origin Types:**
- `thinking-session-note`: Started from Thinking Session
- `spark`: Started from captured spark
- `concept`: Started from canonical concept

**Created by:** Backend FlowSessionService (`ies/backend/src/ies_backend/services/flow_session_service.py`)

## Relationship Patterns

### Domain Graph Relationships

**Standard Academic Relationships:**

| Relationship Type | From | To | Purpose | Example |
|------------------|------|-----|---------|---------|
| `CITES` | Researcher | Researcher | Citation | `(Barkley)-[:CITES]->(Brown)` |
| `DEVELOPS` | Researcher/Concept | Theory/Concept | Evolution | `(Barkley)-[:DEVELOPS]->(EF Theory)` |
| `SUPPORTS` | Chunk/Concept | Theory/Concept | Evidence | `(Chunk)-[:SUPPORTS]->(EF Deficit)` |
| `CONTRADICTS` | Chunk/Concept | Theory/Concept | Tension | `(Study A)-[:CONTRADICTS]->(Study B)` |
| `OPERATIONALIZES` | Assessment | Concept | Measurement | `(BRIEF)-[:OPERATIONALIZES]->(EF)` |
| `COMPONENT_OF` | Concept | Theory/Concept | Part-whole | `(Working Memory)-[:COMPONENT_OF]->(EF)` |
| `FROM_BOOK` | Chunk | Book | Source | `(Chunk)-[:FROM_BOOK]->(Book)` |
| `MENTIONS` | Chunk/Book | Entity | Reference | `(Chunk)-[:MENTIONS]->(Concept)` |

**Evidence Metadata:**

All relationships support `evidence` property:

```cypher
MATCH (c:Concept {name: "Executive Function"})
MATCH (t:Theory {name: "ADHD as EF Deficit"})
MERGE (c)-[r:SUPPORTS]->(t)
SET r.evidence = "Barkley 1997: 'ADHD is fundamentally a disorder of executive function...'"
```

### Personal Graph Relationships

**ADHD-Friendly Discovery Flow:**

| Relationship Type | From | To | Purpose | Example |
|------------------|------|-----|---------|---------|
| `SPARKED_BY` | Spark | Spark/Entity | Origin | `(Spark A)-[:SPARKED_BY]->(Concept)` |
| `LED_TO_DISCOVERY` | Spark/Insight | Insight/Concept | Progression | `(Spark)-[:LED_TO_DISCOVERY]->(Insight)` |
| `ADDRESSES_PROBLEM` | Insight/Concept | FavoriteProblem | Relevance | `(Insight)-[:ADDRESSES_PROBLEM]->(Problem)` |
| `ENERGY_TOWARD` | Person | Entity | Generative | `(User)-[:ENERGY_TOWARD]->(Concept)` |
| `ENERGY_AWAY` | Person | Entity | Draining | `(User)-[:ENERGY_AWAY]->(Topic)` |

**Session Relationships:**

| Relationship Type | From | To | Purpose |
|------------------|------|-----|---------|
| `FROM_CAPTURE` | ThinkingSession | CaptureItem | Session origin |
| `FROM_THINKING` | FlowSession | ThinkingSession | Session progression |
| `HAS_BREADCRUMB` | Session | Node/Edge | Journey tracking |
| `EXTRACTED_ENTITY` | Session | Entity | Entity discovery |

## How Dialogue Mode Adds Edges

**ForgeMode Session Flow:**

1. **User starts session** → `ThinkingSession` node created
2. **AI asks questions** → Classified with `QuestionClass` tags (Schema-Probe, Causal, etc.)
3. **User responds** → Responses recorded in `breadcrumbs`
4. **Session ends** → Entities extracted via backend `/session/end` endpoint
5. **User formalizes concepts** → ConceptExtractor creates:
   - **Neo4j Concept node** with relationships to other concepts
   - **SiYuan Concept document** in `/Concepts/` folder
   - **Bidirectional link** via `be_id` attribute

**Example Relationship Creation:**

From ConceptExtractor workflow:

```typescript
// User creates concept "Shame as Non-Acceptance" with relationships:
// - CONTRASTS_WITH → "Acceptance"
// - COMPONENT_OF → "Metabolization Blocker"

// Backend creates:
MATCH (shame:Concept {name: "Shame as Non-Acceptance"})
MATCH (acceptance:Concept {name: "Acceptance"})
MERGE (shame)-[r:CONTRASTS_WITH]->(acceptance)
SET r.evidence = "Shame prevents acceptance of reality as it is"
```

## How Flow Mode Reads and Expands Graph

**Flow Mode Exploration:**

1. **User opens Flow panel** → Fetches entities via `/graph/entities/by-calibre-id/{calibre_id}`
2. **Click entity** → Loads entity details + relationships (grouped by type)
3. **Explore relationships** → Navigate to related entities
4. **Journey tracking** → Breadcrumbs recorded (node visits, dwell time)
5. **Synthesis** → Claude Sonnet 4 generates insights from breadcrumb trail

**Graph Expansion:**

```cypher
// Flow Mode queries for related entities
MATCH (e:Concept {name: $entityName})-[r]->(related)
RETURN type(r) as relationshipType, collect(related) as relatedEntities
GROUP BY relationshipType

// Returns relationships grouped by type:
// - SUPPORTS: [Concept A, Concept B]
// - COMPONENT_OF: [Theory X]
// - CONTRASTS_WITH: [Concept C]
```

**Breadcrumb Recording:**

FlowSession tracks:
- `visited_nodes`: List of entity IDs explored
- `visited_edges`: List of relationship IDs traversed
- `breadcrumbs`: Array of `{timestamp, node_id, edge_id, user_note}`

**Journey Synthesis:**

Backend `/flow/synthesize` endpoint:
1. Takes breadcrumb trail as input
2. Generates synthesis via Claude Sonnet 4
3. Returns insights discovered during exploration

## Schema Versioning (Personal Graph)

**Version Tracking:**

All ADHD nodes include `schema_version` property (currently `"0.1.0"`).

**Purpose:** Enable future schema migrations without breaking existing data.

**Functions:**

From `library/graph/adhd_graph_client.py`:

- `get_schema_info()`: Returns current version and node counts
- `migrate_schema(from_version, to_version)`: Runs migration functions

**Migration Pattern:**

```python
MIGRATIONS: dict[str, callable] = {
    "0.1.0 -> 0.2.0": lambda session: session.run("...migration cypher...")
}
```

## Pydantic Schemas (Backend APIs)

**Entity Extraction:**
- `ies/backend/src/ies_backend/schemas/entity.py`
  - `ExtractedEntity`: Entity from session transcript
  - `SessionProcessResponse`: Entities created/updated
  - `EntityPageData`: Full entity rendering data

**Quick Capture:**
- `ies/backend/src/ies_backend/schemas/capture.py`
  - `CaptureItem`: Queue item
  - `CaptureStatus`: queued/in_thinking/integrated
  - `AutoExtracted`: AI metadata (entities, topics)

**Thinking Sessions:**
- `ies/backend/src/ies_backend/schemas/thinking.py`
  - `ThinkingSession`: Session state
  - `Breadcrumb`: Journey step
  - `Angle`: Exploration angle

**Flow Sessions:**
- `ies/backend/src/ies_backend/schemas/flow_session.py`
  - `FlowSession`: Session state
  - `FlowOrigin`: Entry point type
  - `GraphNode`, `GraphEdge`: Lightweight representations

## References

**Python Implementation:**
- `library/graph/neo4j_client.py` — Domain knowledge graph client
- `library/graph/adhd_graph_client.py` — Personal knowledge graph client
- `library/graph/adhd_ontology.py` — ADHD entity/relationship types
- `ies/backend/src/ies_backend/schemas/` — Pydantic schemas for backend APIs

**Design Documents:**
- `.interleaved-thinking/final-answer.md` — ADHD-friendly ontology research
- `docs/siyuan-exports/06-adhd-friendly-ontology-design.md` — Visual entity type diagrams
- `docs/siyuan-exports/07-adhd-ontology-real-examples.md` — Concrete usage examples

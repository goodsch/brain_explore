# 3.2 Block Schema

**Purpose:** Blocks are the fundamental organizational units in SiYuan. IES extends SiYuan's native block system with 6 formal block types, each with specific metadata schemas to support ADHD-friendly knowledge capture and structured thinking workflows.

## What is a Block in IES?

A block in IES is:
- **Atomic Unit:** Smallest editable piece of content in SiYuan
- **Typed:** One of 6 formal types (`seed`, `shaping`, `map`, `concept`, `decision`, `log_entry`)
- **Metadata-Rich:** YAML frontmatter + SiYuan custom attributes for bidirectional sync
- **Backend-Linked:** Optional `be_id` and `be_type` fields connect to Neo4j knowledge graph
- **ADHD-Enhanced:** Resonance signals, energy levels, exploration visits for mood-appropriate navigation

## Six Block Types

From `.worktrees/siyuan/ies/plugin/src/types/blocks.ts` (lines 76-84):

```typescript
export type BlockType =
    | 'seed'        // Atomic ideas (seedlings)
    | 'shaping'     // Dialogue segments during structured thinking
    | 'map'         // Visual maps and concept clusters
    | 'concept'     // Canonical concepts in knowledge graph
    | 'decision'    // Project decisions
    | 'log_entry';  // Activity log entries
```

Each block type has a specific purpose and metadata schema:

| Block Type | Purpose | Folder Location | Use Case |
|------------|---------|----------------|----------|
| `seed` | Atomic ideas | `/Seedlings/` | Raw captures, unprocessed insights |
| `shaping` | Dialogue segments | `/Sessions/{mode}/` | Structured thinking sessions |
| `map` | Visual representations | `/Flow_Maps/` | Concept clusters, timelines, schemas |
| `concept` | Canonical concepts | `/Concepts/` | Formalized knowledge graph nodes |
| `decision` | Project decisions | `/Projects/` | Decision tracking with rationale |
| `log_entry` | Activity logs | `/Daily/` | Daily notes, journaling |

## BaseMeta Interface (Shared Fields)

All block types inherit from `BaseMeta` (`.worktrees/siyuan/ies/plugin/src/types/blocks.ts` lines 88-99):

```typescript
export interface BaseMeta {
    block_type?: BlockType;
    be_id?: string | null;              // Backend entity ID (Neo4j node ID)
    be_type?: string | null;            // Backend entity type (Spark, Insight, Concept, etc.)
    resonance_signal?: ResonanceSignal | null;
    energy_level?: EnergyLevel | null;
    exploration_visits?: number;
    status?: UserStatus;
    created_at?: string;
    last_touched_at?: string;
}
```

**Field Descriptions:**

| Field | Type | Purpose | Example |
|-------|------|---------|---------|
| `block_type` | `BlockType?` | Which of 6 block schemas this is | `'seed'`, `'concept'` |
| `be_id` | `string?` | Backend node ID for bidirectional sync | `'spark_abc123'`, `'concept_xyz789'` |
| `be_type` | `string?` | Backend node label | `'Spark'`, `'Concept'`, `'ThinkingSession'` |
| `resonance_signal` | `ResonanceSignal?` | Emotional retrieval cue (8 signals) | `'curiosity'`, `'delight'`, `'tension'` |
| `energy_level` | `EnergyLevel?` | Mood-appropriate navigation (3 levels) | `'low'`, `'medium'`, `'high'` |
| `exploration_visits` | `number?` | Visit counter for recency-based navigation | `0`, `5`, `12` |
| `status` | `UserStatus?` | User engagement state | `'captured'`, `'exploring'`, `'anchored'` |
| `created_at` | `string?` | ISO timestamp of creation | `'2025-12-05T10:30:00Z'` |
| `last_touched_at` | `string?` | ISO timestamp of last edit/visit | `'2025-12-05T14:22:00Z'` |

**ADHD Extensions (Why They Exist):**

- **`resonance_signal`**: Emotional memory is stronger than semantic memory for ADHD (Gabor Maté). 8 emotional cues support retrieval.
- **`energy_level`**: Interest-based nervous system (Tamara Rosier). Navigate to content appropriate for current energy state.
- **`exploration_visits`**: Recency bias in ADHD. Tracks visit frequency for "forgotten captures" queries.

## Block-Specific Metadata Schemas

### 1. SeedBlockMeta

**Purpose:** Atomic ideas in `/Seedlings/` folders

From `blocks.ts` lines 128-141:

```typescript
export interface SeedBlockMeta extends BaseMeta {
    block_type: 'seed';
    idea_type: IdeaType;              // 7 types: question, insight, observation, etc.
    domain?: string;
    source?: 'inbox' | 'dialogue' | 'project' | 'external' | string;
    clarity?: ClarityLevel;           // fuzzy → partial → clear
    confidence?: ConfidenceLevel;      // low → medium → high
    related_concepts?: string[];
    related_seedlings?: string[];
    tags?: string[];
    source_capture_id?: string;
}
```

**See:** `3.1-Seed-Schema.md` for complete details on seed blocks.

### 2. ShapingBlockMeta

**Purpose:** Dialogue segments during structured thinking sessions

From `blocks.ts` lines 145-152:

```typescript
export interface ShapingBlockMeta extends BaseMeta {
    block_type: 'shaping';
    session_id: string;               // Links to ThinkingSession in backend
    speaker: 'user' | 'ai';
    phase: 'exploration' | 'challenge' | 'synthesis' | 'meta';
    related_seedlings?: string[];
}
```

**Used in:** `/Sessions/{mode}/` documents (Learning, Articulating, Planning, Ideating, Reflecting)

**Integration:** Session documents created by `createSessionDocument()` in `siyuan-structure.ts` link to backend via `session_id`.

### 3. MapBlockMeta

**Purpose:** Visual maps and concept clusters

From `blocks.ts` lines 157-170:

```typescript
export interface MapBlockMeta extends BaseMeta {
    block_type: 'map';
    map_type:
        | 'concept_cluster'
        | 'timeline'
        | 'system'
        | 'schema'
        | 'perspective'
        | 'other';
    focus?: string;
    related_concepts?: string[];
    related_seedlings?: string[];
    entry_points?: string[];         // Entry points for Flow mode exploration
}
```

**Used in:** `/Flow_Maps/` folder for visual exploration artifacts

### 4. ConceptBlockMeta

**Purpose:** Canonical concepts in the knowledge graph

From `blocks.ts` lines 175-182:

```typescript
export interface ConceptBlockMeta extends BaseMeta {
    block_type: 'concept';
    concept_id: string;               // Backend Neo4j node ID
    concept_name: string;
    domain?: string;
    concept_status?: 'active' | 'draft' | 'deprecated';
    version?: string | number;
}
```

**Used in:** `/Concepts/` folder for formalized knowledge graph nodes

**Dual Save:** Created by `createConceptDocument()` in `siyuan-structure.ts` which saves to both Neo4j (graph relationships) and SiYuan (document editing).

### 5. DecisionBlockMeta

**Purpose:** Project decisions with rationale tracking

From `blocks.ts` lines 187-195:

```typescript
export interface DecisionBlockMeta extends BaseMeta {
    block_type: 'decision';
    project_id: string;
    decision_status: 'pending' | 'accepted' | 'rejected' | 'revisited';
    rationale?: string;
    decided_at?: string;
    related_maps?: string[];
    related_concepts?: string[];
}
```

**Used in:** `/Projects/` folder for decision documentation

### 6. LogEntryMeta

**Purpose:** Activity logs and daily notes

From `blocks.ts` lines 200-207:

```typescript
export interface LogEntryMeta extends BaseMeta {
    block_type: 'log_entry';
    context: 'project' | 'system' | 'personal' | string;
    project_id?: string;
    timestamp: string;
    summary: string;
    related_blocks?: string[];
}
```

**Used in:** `/Daily/` folder for daily capture and journaling

## How Blocks Relate to SiYuan's Native System

SiYuan's native blocks have:
- **Block ID:** Unique 20-character identifier (e.g., `20251201113102-ctr4bco`)
- **Block Type:** SiYuan types (`d` document, `p` paragraph, `h` heading, `l` list, etc.)
- **Custom Attributes:** Key-value pairs stored as `custom-*` attributes

IES extends this with:
- **YAML Frontmatter:** Human-readable metadata at top of documents
- **Custom Attributes:** Machine-readable sync (`custom-be_id`, `custom-be_type`, `custom-status`, etc.)
- **Dual Storage:** Metadata exists in BOTH frontmatter (editing) AND attributes (querying)

**Why Both?**
- **YAML Frontmatter:** Easy to read/edit in Markdown
- **SiYuan Attributes:** Enables SQL queries (`SELECT * FROM blocks WHERE custom-status = 'exploring'`)

## Frontmatter/YAML Standards

IES uses consistent YAML frontmatter structure for all block types:

```yaml
---
block_type: seed
idea_type: question
status: exploring
be_id: spark_abc123
be_type: Spark
energy_level: medium
resonance_signal: curiosity
created_at: "2025-12-05T10:30:00Z"
last_touched_at: "2025-12-05T14:22:00Z"
---
```

**Serialization:** The `serializeFrontmatter()` function in `siyuan-structure.ts` (lines 406-452) handles:
- Arrays: `tags: [adhd, shame]` or multi-line YAML list
- Nested objects: `key:\n  subkey: value`
- Dates: ISO 8601 format
- Null values: Omitted (not serialized)

## SiYuan Custom Attributes (Backend Sync)

IES syncs metadata to SiYuan's custom attribute system for SQL querying:

**Standard Attributes:**
- `custom-be_id`: Backend node ID
- `custom-be_type`: Backend node label
- `custom-status`: User engagement status
- `custom-block_type`: Which of 6 block types
- `custom-created_at`: Creation timestamp
- `custom-last_touched_at`: Last modification timestamp

**ADHD Attributes:**
- `custom-energy_level`: Mood-appropriate navigation
- `custom-resonance_signal`: Emotional retrieval cue
- `custom-exploration_visits`: Visit counter

**Capture Attributes:**
- `custom-capture_status`: AI processing state (raw/classified/processed)
- `custom-capture_channel`: Where captured from (phone/readest/web/voice)
- `custom-capture_source`: Specific source (ios_shortcut/readest/browser_extension)

**Applied via:** `setBlockAttrs(blockId, attributes)` function from SiYuan API

## Block Metadata Union Type

All block metadata types unified in single union (`blocks.ts` lines 212-219):

```typescript
export type BlockMeta =
    | QuickCaptureMeta
    | SeedBlockMeta
    | ShapingBlockMeta
    | MapBlockMeta
    | ConceptBlockMeta
    | DecisionBlockMeta
    | LogEntryMeta;
```

**Type Safety:** TypeScript ensures only valid fields for each block type.

## Implementation Files

**TypeScript Schema:**
- `.worktrees/siyuan/ies/plugin/src/types/blocks.ts` (272 lines)
  - Defines all 6 block metadata interfaces
  - `BaseMeta`, `BlockType`, `BlockMeta` union
  - ADHD extension types: `ResonanceSignal`, `EnergyLevel`, `UserStatus`
  - Helper constants: `IDEA_TYPE_LABELS`, `IDEA_TYPE_ICONS`, `SEEDLING_FOLDER_MAP`

**Document Creation:**
- `.worktrees/siyuan/ies/plugin/src/utils/siyuan-structure.ts`
  - `createSessionDocument()`: Creates shaping blocks in `/Sessions/{mode}/` (lines 794-984)
  - `createConceptDocument()`: Creates concept blocks in `/Concepts/` (lines 1009-1106)
  - `createSparkWithBackend()`: Creates log_entry blocks in `/Daily/` (lines 518-588)
  - `serializeFrontmatter()`: YAML serialization (lines 406-452)

**Block Attribute Sync:**
- `setBlockAttrs(blockId, attrs)`: SiYuan API wrapper
- Applied in: `createSparkWithBackend()`, `promoteToInsight()`, `createSessionDocument()`, `createConceptDocument()`

## Example Block (Full Document)

**Concept Block in `/Concepts/Executive-Function.md`:**

```yaml
---
block_type: concept
concept_id: concept_abc123
concept_name: Executive Function
domain: neuroscience
concept_status: active
version: 1
status: anchored
be_id: concept_abc123
be_type: Concept
energy_level: high
created_at: "2025-12-05T10:00:00Z"
last_touched_at: "2025-12-05T15:30:00Z"
---

# Executive Function

**Type:** Concept

## Definition

The set of cognitive processes that enable goal-directed behavior, including working memory, inhibitory control, and cognitive flexibility.

## Also Known As

- EF
- Cognitive Control
- Top-Down Regulation

## Relationships

- **Component Of** → [[Prefrontal Cortex Function]]
  - *Executive functions are primarily regulated by the prefrontal cortex*
- **Contrasts With** → [[Automatic Processing]]
  - *EF requires effortful control, while automatic processing is stimulus-driven*
- **Causes** → [[Goal Achievement]]
  - *Intact EF enables complex problem-solving and long-term planning*

## Supporting Evidence

> "Executive function deficits are the hallmark of ADHD, affecting working memory, planning, and emotional regulation." — Russell Barkley, "Taking Charge of ADHD"

## Origin

This concept was extracted from session `session_xyz789`.
```

## References

**TypeScript Implementation:**
- `.worktrees/siyuan/ies/plugin/src/types/blocks.ts` — Complete block schema definitions
- `.worktrees/siyuan/ies/plugin/src/utils/siyuan-structure.ts` — Document creation functions

**Design Documents:**
- `docs/IES_SiYuan_Architecture/README.md` — Reference architecture with block schema specifications
- `docs/ARCHITECTURE-COMPARISON.md` — Design decisions for merged architecture

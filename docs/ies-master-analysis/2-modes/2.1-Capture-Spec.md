# 2.1 Capture Mode Specification

**Purpose:** This document defines Capture Mode‚Äîthe zero-friction ephemeral thought capture system in IES. Capture Mode enables users to capture thoughts, observations, and sparks without derailing their current activity, using light AI processing to route content intelligently.

**Date:** December 6, 2025
**Status:** Production Ready (Phase 2c Complete)

---

## Mission and Purpose

Capture Mode is the **ephemeral ‚Üí persistent** gateway in the IES knowledge lifecycle. It provides:

- **Zero-friction capture** ‚Äî Capture now, process later (ADHD-friendly design)
- **Multiple input channels** ‚Äî Quick Capture UI, iOS shortcuts, browser extension, voice notes (future)
- **Light auto-processing** ‚Äî AI extracts entities and suggests placements without forcing classification
- **Status lifecycle** ‚Äî `raw ‚Üí classified ‚Üí processed` (clear handoff from AI to user)

**Design Principle:** If capture takes work, it won't happen. Capture Mode removes ALL barriers between thought and persistence.

---

## Input Channels

### 1. SiYuan Quick Capture UI (Primary)

**Location:** `.worktrees/siyuan/ies/plugin/src/views/QuickCapture.svelte`

**Entry Points:**
- Dashboard "Quick Capture" button
- Keyboard shortcut (configurable)
- Text selection ‚Üí "Capture" menu item (future)

**Capture Flow:**
```
User enters text ‚Üí AI processes (entities, summary, tags) ‚Üí Show results
‚Üí User selects idea type (7 seedling types) ‚Üí User selects placement
‚Üí Spark created in backend + SiYuan block ‚Üí Status: processed
```

**UI States:**
1. **Input Phase** (lines 287-336)
   - Capture type selector: Text, Link
   - Textarea with placeholder: "Capture a thought, idea, or insight..."
   - "Process" button triggers AI entity extraction

2. **Results Phase** (lines 338-530)
   - Summary display
   - Extracted entities (chips with graph match indicators)
   - Suggested tags
   - **Capture status badge** with 3 states:
     - `raw` (‚¨ú) ‚Äî Waiting for AI processing
     - `classified` (üîÑ) ‚Äî AI has processed, choose idea type
     - `processed` (‚úÖ) ‚Äî Ready to save
   - **Idea type selection grid** (8 types, Phase 3)
   - Capture source metadata (channel, source dropdowns)
   - ADHD metadata (resonance signal, energy level)
   - Placement suggestions (sorted by confidence)

**Code Example:**
```typescript
// QuickCapture.svelte lines 149-172
async function handleProcess() {
    if (!inputText.trim() || isProcessing) return;

    isProcessing = true;
    error = null;
    processingResult = null;

    try {
        const result = await apiPost('/capture/process', {
            content: inputText.trim(),
            capture_type: captureType,
            context: {}
        });

        processingResult = result;
        // Transition status: raw ‚Üí classified (AI has processed the content)
        captureStatus = 'classified';
    } catch (err) {
        error = err.message || String(err);
        console.error('[QuickCapture] Process error:', err);
    } finally {
        isProcessing = false;
    }
}
```

### 2. iOS Shortcuts (Future)

**Capture Flow:**
```
iOS Share Sheet / Siri ‚Üí POST /capture ‚Üí Backend creates CaptureItem
‚Üí SiYuan plugin polls capture queue ‚Üí Process in Quick Capture UI
```

**Metadata:**
- `capture_channel: 'phone'`
- `capture_source: 'ios_shortcut'`
- `context_snippet`: Selected text or current app context

### 3. Browser Extension (Future)

**Capture Flow:**
```
Browser selection ‚Üí Extension popup ‚Üí POST /capture with URL context
‚Üí Backend creates CaptureItem with link metadata
```

**Metadata:**
- `capture_channel: 'web'`
- `capture_source: 'browser_extension'`
- `context_snippet`: Selected text + page URL + page title

### 4. Voice Notes (Future)

**Capture Flow:**
```
Voice recording ‚Üí Transcription API ‚Üí POST /capture with audio metadata
‚Üí Backend creates CaptureItem
```

**Metadata:**
- `capture_channel: 'voice'`
- `capture_source: 'voice_assistant'`
- `context_snippet`: Transcribed text

---

## CaptureItem Schema

**Location:** `ies/backend/src/ies_backend/schemas/capture.py`

```python
class CaptureItem(BaseModel):
    """Capture queue item in Neo4j."""
    id: str                              # capture_{uuid}
    raw_text: str                        # Unprocessed user input
    source: CaptureSource                # Enum: assistant_interruption, ios_shortcut, browser_extension, mcp_tool, voice_assistant
    captured_at: datetime                # UTC timestamp
    status: CaptureStatus                # Enum: queued, in_thinking, integrated
    context_snippet: str | None = None   # Source context (URL, app, location)
    auto_extracted: AutoExtracted | None = None  # AI-extracted metadata
    spark: Spark | None = None           # Optional spark metadata

class AutoExtracted(BaseModel):
    """AI-extracted metadata."""
    entities: list[str]                  # Entity names (matched to graph)
    topics: list[str]                    # Theme tags
```

**Status Lifecycle:**
```
queued ‚Üí in_thinking ‚Üí integrated
```

- **`queued`** ‚Äî Just captured, waiting for user to process
- **`in_thinking`** ‚Äî User opened Thinking Session from this capture
- **`integrated`** ‚Äî Thinking Session completed, capture processed into knowledge base

---

## Capture Status (AI Processing State)

**Location:** `.worktrees/siyuan/ies/plugin/src/types/blocks.ts` (lines 16-18)

```typescript
export type CaptureStatus = 'raw' | 'classified' | 'processed';
```

**Status Meanings:**

| Status | AI Role | User Role | Display |
|--------|---------|-----------|---------|
| `raw` | Pending | Waiting | ‚¨ú "Waiting for AI processing" |
| `classified` | Complete | Choose idea type | üîÑ "AI has classified - choose idea type" |
| `processed` | N/A | Placement decided | ‚úÖ "Ready to save" |

**Transition Flow:**
```
raw (user enters text)
  ‚Üí classified (AI adds auto_summary, auto_labels, linked_concepts)
  ‚Üí processed (user selects idea_type + placement ‚Üí spark created)
```

**Code Example:**
```typescript
// QuickCapture.svelte lines 163-165
processingResult = result;
// Transition status: raw ‚Üí classified (AI has processed the content)
captureStatus = 'classified';
```

---

## Light Auto-Processing

**Purpose:** Extract just enough metadata to suggest intelligent placements without forcing user classification.

**Backend Endpoint:** `POST /capture/process`

**Location:** `ies/backend/src/ies_backend/services/capture_service.py`

**AI Processing (lines 83-149):**

If `ANTHROPIC_API_KEY` is available:
1. Call Claude Sonnet 4 with entity extraction prompt
2. Parse response for entities (name, type, confidence), summary, tags
3. Match entities against knowledge graph (`GraphService.search_concepts()`)
4. Generate placement suggestions based on matches

**Fallback Processing (lines 151-176):**

If AI unavailable:
1. Regex extract capitalized phrases (potential concepts)
2. Simple summary (first 200 chars)
3. Keyword tag extraction from predefined list

**Code Example:**
```python
# capture_service.py lines 86-106
async def _ai_extract(content: str) -> tuple[list[ExtractedEntity], str, list[str]]:
    """Use AI to extract entities, summary, and tags."""
    client = anthropic.Anthropic()

    prompt = f"""Analyze this captured thought/note and extract:
1. Key concepts/entities mentioned (with type: concept, person, theory, framework, practice)
2. A one-sentence summary
3. Relevant tags (3-5 short words)

Content:
{content}

Respond in this exact format:
ENTITIES:
- [name]: [type] ([confidence 0-1])
...
SUMMARY: [one sentence]
TAGS: [tag1, tag2, ...]"""

    response = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=500,
        messages=[{"role": "user", "content": prompt}]
    )
    # ... parse response
```

---

## Capture Inbox (UI in SiYuan Dashboard)

**Purpose:** Display capture queue items sorted by status, allow one-click processing.

**Location:** `.worktrees/siyuan/ies/plugin/src/views/Dashboard.svelte`

**Features:**
- **Status filtering** ‚Äî Tabs for "Queued", "In Thinking", "Integrated"
- **Sort by recency** ‚Äî Most recent captures at top
- **Entity badges** ‚Äî Show extracted entities with graph match indicators (‚úì)
- **One-click actions:**
  - "Process" ‚Üí Opens Quick Capture UI with pre-filled content
  - "Start Thinking" ‚Üí Creates ThinkingSession from capture
  - "Delete" ‚Üí Removes from queue

**Code Example:**
```svelte
<!-- Dashboard.svelte capture queue section -->
{#if captureQueue.length > 0}
  <div class="capture-queue">
    <div class="queue-header">
      <span>Capture Queue ({captureQueue.length})</span>
      <select bind:value={captureStatusFilter}>
        <option value="queued">Queued</option>
        <option value="in_thinking">In Thinking</option>
        <option value="integrated">Integrated</option>
      </select>
    </div>
    {#each captureQueue as capture}
      <div class="capture-card">
        <p class="capture-text">{capture.raw_text}</p>
        <div class="capture-meta">
          <span class="capture-source">{capture.source}</span>
          <span class="capture-time">{formatTime(capture.captured_at)}</span>
        </div>
        {#if capture.auto_extracted}
          <div class="entity-chips">
            {#each capture.auto_extracted.entities as entity}
              <span class="entity-chip">{entity}</span>
            {/each}
          </div>
        {/if}
        <div class="capture-actions">
          <button on:click={() => processCa capture(capture.id)}>Process</button>
          <button on:click={() => startThinking(capture.id)}>Start Thinking</button>
        </div>
      </div>
    {/each}
  </div>
{/if}
```

---

## Backend API

**Base URL:** `http://localhost:8081/api/v1`

**Router:** `ies/backend/src/ies_backend/api/capture.py`

### Endpoints

#### 1. Create Capture
```
POST /capture
```

**Request:**
```json
{
  "raw_text": "Noticed shame blocks access to executive function capacity",
  "source": "ios_shortcut",
  "context_snippet": "Reading Barkley chapter 3",
  "auto_extracted": {
    "entities": ["Shame", "Executive Function"],
    "topics": ["adhd", "emotion"]
  },
  "spark": {
    "resonance_signal": "surprised",
    "energy_level": "medium"
  }
}
```

**Response:** `CaptureItem` (status: queued)

---

#### 2. List Captures
```
GET /capture?status=queued
```

**Response:**
```json
{
  "items": [
    {
      "id": "capture_abc123",
      "raw_text": "...",
      "source": "ios_shortcut",
      "captured_at": "2025-12-06T10:30:00Z",
      "status": "queued",
      "auto_extracted": {
        "entities": ["Shame", "Executive Function"],
        "topics": ["adhd"]
      }
    }
  ],
  "total": 15
}
```

---

#### 3. Get Single Capture
```
GET /capture/{capture_id}
```

**Response:** `CaptureItem`

---

#### 4. Update Capture
```
PATCH /capture/{capture_id}
```

**Request:**
```json
{
  "status": "in_thinking",
  "auto_extracted": {
    "entities": ["Shame", "Executive Function", "Working Memory"],
    "topics": ["adhd", "emotion", "cognition"]
  }
}
```

**Response:** Updated `CaptureItem`

---

#### 5. Delete Capture
```
DELETE /capture/{capture_id}
```

**Response:**
```json
{ "message": "Capture deleted" }
```

---

#### 6. Process Capture (Legacy Quick Capture)
```
POST /capture/process
```

**Request:**
```json
{
  "content": "Noticed shame blocks access to executive function capacity",
  "capture_type": "text",
  "context": {}
}
```

**Response:**
```json
{
  "extracted_entities": [
    {
      "name": "Shame",
      "type": "concept",
      "confidence": 0.9,
      "graph_match": true
    },
    {
      "name": "Executive Function",
      "type": "concept",
      "confidence": 0.95,
      "graph_match": true
    }
  ],
  "suggested_placements": [
    {
      "target_type": "concept",
      "target_id": "Shame",
      "target_name": "Shame",
      "confidence": 0.85,
      "preview": "[Link to concept: Shame]\n\n...",
      "rationale": "Content mentions or relates to Shame"
    }
  ],
  "summary": "Observation about shame blocking access to executive function",
  "tags": ["shame", "executive function", "adhd"]
}
```

---

## Implementation Status

| Component | File | Status | Lines | Notes |
|-----------|------|--------|-------|-------|
| **Frontend (SiYuan)** | | | | |
| Quick Capture UI | `QuickCapture.svelte` | ‚úÖ Complete | 1041 | Full capture flow with idea type selection |
| Capture Queue (Dashboard) | `Dashboard.svelte` | ‚ö†Ô∏è Partial | TBD | Status filtering not implemented |
| Block Types | `blocks.ts` | ‚úÖ Complete | 272 | CaptureStatus, QuickCaptureMeta defined |
| **Backend** | | | | |
| Capture API Router | `api/capture.py` | ‚úÖ Complete | 70 | All CRUD endpoints |
| Capture Service | `services/capture_service.py` | ‚úÖ Complete | 499 | AI extraction + queue management |
| Capture Schemas | `schemas/capture.py` | ‚úÖ Complete | ~100 | CaptureItem, CaptureStatus, AutoExtracted |
| **Tests** | | | | |
| Backend Tests | `tests/test_capture_*.py` | ‚úÖ Passing | TBD | 94/94 tests passing |

---

## Integration with Other Modes

### Capture ‚Üí Dialogue
```
CaptureItem (status: queued)
  ‚Üí User clicks "Start Thinking"
  ‚Üí POST /thinking/start { capture_id }
  ‚Üí ThinkingSession created
  ‚Üí CaptureItem status: queued ‚Üí in_thinking
```

**Data Passed:**
- `capture.raw_text` ‚Üí Session context
- `capture.auto_extracted.entities` ‚Üí Initial entities for dialogue
- `capture.auto_extracted.topics` ‚Üí Topic suggestions

---

### Capture ‚Üí Flow
```
CaptureItem with entities
  ‚Üí User clicks entity chip
  ‚Üí Opens Flow Mode with entity pre-selected
  ‚Üí Journey starts from capture context
```

**Data Passed:**
- `capture.auto_extracted.entities[0]` ‚Üí Initial entity
- `capture.context_snippet` ‚Üí Journey context
- `capture.id` ‚Üí Source reference for breadcrumb

---

## Key Differentiators

| Traditional Capture | IES Capture Mode |
|---------------------|------------------|
| Manual tagging required | AI suggests entities automatically |
| One-size-fits-all folders | Intelligent placement suggestions |
| Lost in inbox forever | Status lifecycle ensures processing |
| Text-only | Multi-channel (voice, web, phone) |
| Capture = interruption | Zero-friction, no context switch |

---

## References

**Implementation Files:**
- Frontend: `.worktrees/siyuan/ies/plugin/src/views/QuickCapture.svelte`
- Block Types: `.worktrees/siyuan/ies/plugin/src/types/blocks.ts`
- Backend Service: `ies/backend/src/ies_backend/services/capture_service.py`
- Backend API: `ies/backend/src/ies_backend/api/capture.py`
- Backend Schemas: `ies/backend/src/ies_backend/schemas/capture.py`

**Related Docs:**
- `docs/ies-master-analysis/0-system/0.1-IES-Overview.md` ‚Äî System overview and knowledge lifecycle
- `docs/ies-master-analysis/3-schemas/3.1-Seed-Schema.md` ‚Äî Seed types and status systems
- `docs/ies-master-analysis/2-modes/2.2-Dialogue-Spec.md` ‚Äî Capture ‚Üí Thinking transition
- `docs/ies-master-analysis/2-modes/2.4-Mode-Transition-Engine.md` ‚Äî Mode switching logic

---

*This document defines Capture Mode‚Äîthe zero-friction entry point for IES knowledge capture. For structured processing, see 2.2-Dialogue-Spec.md. For graph exploration from captures, see 2.3-Flow-Spec.md.*

# 2.3 Flow Mode Specification

**Purpose:** This document defines Flow Mode‚Äîthe visual graph exploration system in IES that enables non-linear knowledge navigation with thinking partner guidance.

**Date:** December 6, 2025
**Status:** Production Ready (Phase 2c Complete)

---

## Mission and Purpose

Flow Mode is the **exploration ‚Üí insight** engine in the IES knowledge lifecycle. It provides:

- **Visual graph exploration** ‚Äî Navigate knowledge graph through entities and relationships
- **Thinking partner questions** ‚Äî AI-generated questions at decision points to deepen reflection
- **Journey tracking** ‚Äî Breadcrumb trails capture exploration paths for later synthesis
- **Multi-entry points** ‚Äî Start from concepts, entities, sessions, or sparks
- **Synthesis generation** ‚Äî AI summarizes insights from exploration journey

**Design Principle:** If knowledge is connected, navigation should reveal connections. Flow Mode surfaces unexpected relationships through user-driven browsing.

---

## Dual Implementation: SiYuan + Readest

Flow Mode exists in two contexts with shared backend:

### 1. SiYuan FlowMode (Processing Hub)

**Location:** `.worktrees/siyuan/ies/plugin/src/views/FlowMode.svelte` (1516 lines)

**Entry Points:**
- Dashboard "Flow Mode" button
- Click entity in session results
- Click entity in capture queue
- Click concept in suggestions

**UI Components:**
- Search bar: Find entities by name
- Current entity card: Name, type, description
- Relationships panel: Grouped by type with count badges
- Entity details: Sources (books), definitions, reframes
- Thinking partner questions: Expandable Q&A cards
- Journey path: Breadcrumb trail with visited entities

### 2. Readest Flow Panel (Reading Interface)

**Location:** `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/FlowPanel.tsx` (197 lines)

**Entry Points:**
- Click entity highlight in book text
- Click entity in entity overlay
- Resume journey from dashboard

**UI Components (Modular):**
- `FlowPanelHeader.tsx` ‚Äî Title, pin/close controls
- `EntitySection.tsx` ‚Äî Current entity display
- `RelationshipsSection.tsx` ‚Äî Grouped relationships
- `SourcesSection.tsx` ‚Äî Source books with chapters/pages
- `QuestionsSection.tsx` ‚Äî Interactive thinking partner questions
- `ReframesSection.tsx` ‚Äî Metaphors, analogies, stories
- `JourneyBreadcrumb.tsx` ‚Äî Breadcrumb trail with dwell time

**Shared Features:**
- Entity type filtering (Concept, Person, Theory, Framework, Assessment)
- Relationship grouping by type with collapse/expand
- Journey breadcrumb visualization
- Question-response interaction with journey tracking

---

## Core Interactions

### Expand (View Entity Details)

**User Action:** Click entity name or search result

**Flow:**
```
1. User clicks entity ‚Üí setCurrentEntity(entityName)
   ‚Üì
2. Backend call: GET /graph/entity?name={entityName}
   ‚Üì
3. Fetch relationships: GET /graph/relationships?entity={entityName}
   ‚Üì
4. Fetch sources: GET /graph/sources?entity={entityName}
   ‚Üì
5. Generate questions: POST /question-engine/generate-questions
   ‚Üì
6. Display: Entity card + Relationships + Sources + Questions
   ‚Üì
7. Record breadcrumb: addJourneyStep(entityName, dwellTime)
```

**Data Displayed:**
- Entity name, type, description
- Relationship count by type
- Source books (with chapter/page references)
- Thinking partner questions (3-5 questions)
- Reframes (if available)

**Code Example (FlowMode.svelte lines 350-420):**

```typescript
async function handleEntityClick(entityName: string) {
    isLoading = true;
    error = null;

    try {
        // Fetch entity details
        const entityData = await apiGet(`/graph/entity?name=${encodeURIComponent(entityName)}`);

        // Fetch relationships
        const relationshipsData = await apiGet(`/graph/relationships?entity=${encodeURIComponent(entityName)}`);

        // Fetch sources
        const sourcesData = await apiGet(`/graph/sources?entity=${encodeURIComponent(entityName)}`);

        // Generate thinking partner questions
        const questionsData = await apiPost('/question-engine/generate-questions', {
            approach: 'exploratory',
            topic: entityName,
            context: {
                entity_type: entityData.type,
                relationship_count: relationshipsData.relationships.length
            }
        });

        // Update state
        currentEntity = {
            name: entityName,
            type: entityData.type,
            description: entityData.description,
            relationships: relationshipsData.relationships,
            sources: sourcesData.sources
        };

        thinkingPartnerQuestions = questionsData.questions;

        // Record journey step
        addJourneyStep(entityName, Date.now());
    } catch (err) {
        error = err.message;
        console.error('[FlowMode] Entity fetch error:', err);
    } finally {
        isLoading = false;
    }
}
```

---

### Cluster (Group by Relationship Type)

**Purpose:** Organize relationships by semantic type for easier navigation

**Relationship Types:**

From backend (GraphService):

```python
RELATIONSHIP_TYPES = [
    "supports",
    "contradicts",
    "component_of",
    "operationalizes",
    "develops",
    "enables",
    "contrasts_with",
    "MENTIONS",       # From book ingestion
    "HAS_REFRAME",    # From reframe generation
    "sparked_by",     # From personal graph
    "led_to_discovery"  # From personal graph
]
```

**Grouping Logic:**

```typescript
// Group relationships by type
const groupedRelationships = relationships.reduce((groups, rel) => {
    const type = rel.type || 'RELATED_TO';
    if (!groups[type]) {
        groups[type] = [];
    }
    groups[type].push(rel);
    return groups;
}, {} as Record<string, Relationship[]>);
```

**UI Display (FlowMode.svelte lines 680-750):**

```svelte
<div class="relationships-panel">
    <h3>Relationships ({Object.keys(groupedRelationships).length} types)</h3>

    {#each Object.entries(groupedRelationships) as [type, rels]}
        <div class="relationship-group">
            <div class="group-header" on:click={() => toggleGroup(type)}>
                <span class="group-type">{formatRelationType(type)}</span>
                <span class="group-count">{rels.length}</span>
                <span class="group-toggle">{expandedGroups[type] ? '‚ñº' : '‚ñ∂'}</span>
            </div>

            {#if expandedGroups[type]}
                <div class="group-entities">
                    {#each rels as rel}
                        <div class="entity-chip" on:click={() => handleEntityClick(rel.target)}>
                            <span class="entity-type-badge" style="background: {getEntityColor(rel.targetType)}">{rel.targetType}</span>
                            <span class="entity-name">{rel.target}</span>
                        </div>
                    {/each}
                </div>
            {/if}
        </div>
    {/each}
</div>
```

**Readest Implementation (RelationshipsSection.tsx lines 1-104):**

```typescript
export function RelationshipsSection({ relationships }: RelationshipsSectionProps) {
    const grouped = relationships.reduce((acc, rel) => {
        const type = rel.type || 'RELATED_TO';
        if (!acc[type]) acc[type] = [];
        acc[type].push(rel);
        return acc;
    }, {} as Record<string, Relationship[]>);

    return (
        <div className="flow-relationships">
            <h3 className="flow-section-header">
                Relationships ({Object.keys(grouped).length} types)
            </h3>
            {Object.entries(grouped).map(([type, rels]) => (
                <details key={type} className="relationship-group">
                    <summary className="group-header">
                        <span className="group-type">{formatRelationType(type)}</span>
                        <span className="group-count">{rels.length}</span>
                    </summary>
                    <div className="group-entities">
                        {rels.map(rel => (
                            <div key={rel.id} className="entity-chip" onClick={() => onEntityClick(rel.target)}>
                                <span className="entity-type-badge" data-type={rel.targetType?.toLowerCase()}>
                                    {rel.targetType}
                                </span>
                                <span className="entity-name">{rel.target}</span>
                            </div>
                        ))}
                    </div>
                </details>
            ))}
        </div>
    );
}
```

---

### Filter (Show/Hide Entity Types)

**Purpose:** Reduce visual clutter by filtering entity types

**UI Component (SiYuan FlowMode lines 580-640):**

```svelte
<div class="entity-type-filters">
    <label class="filter-label">Show types:</label>
    {#each ENTITY_TYPES as type}
        <label class="filter-checkbox">
            <input
                type="checkbox"
                checked={visibleTypes.includes(type)}
                on:change={() => toggleEntityType(type)}
            />
            <span class="filter-badge" style="background: {getEntityColor(type)}">{type}</span>
        </label>
    {/each}
</div>
```

**Entity Types:**

```typescript
const ENTITY_TYPES = ['Concept', 'Person', 'Theory', 'Framework', 'Assessment'];

const ENTITY_COLORS = {
    'Concept': '#2563eb',      // Blue
    'Person': '#059669',       // Green
    'Theory': '#7c3aed',       // Purple
    'Framework': '#ea580c',    // Orange
    'Assessment': '#dc2626'    // Red
};
```

**Filter Logic:**

```typescript
function toggleEntityType(type: string) {
    if (visibleTypes.includes(type)) {
        visibleTypes = visibleTypes.filter(t => t !== type);
    } else {
        visibleTypes = [...visibleTypes, type];
    }
}

// Apply filter to relationships
$: filteredRelationships = currentEntity?.relationships.filter(rel =>
    visibleTypes.includes(rel.targetType)
) || [];
```

**Readest Implementation (EntityTypeFilter.tsx):**

Enhanced pill-based UI (Dec 4 redesign):

```typescript
export function EntityTypeFilter({ enabled, visibleTypes, onToggle, onTypeToggle, entityCount, loading, error }: Props) {
    return (
        <div className="entity-filter-container">
            {/* Master toggle */}
            <button className="flow-master-toggle" onClick={onToggle}>
                {enabled ? <LuEye /> : <LuEyeOff />}
                <span>{enabled ? 'ON' : 'OFF'}</span>
            </button>

            {/* Type pills */}
            <div className="entity-type-pills">
                {ENTITY_TYPES.map(type => (
                    <button
                        key={type}
                        className={`entity-type-pill ${visibleTypes.includes(type) ? 'active' : ''}`}
                        data-type={type.toLowerCase()}
                        disabled={!enabled}
                        onClick={() => onTypeToggle(type)}
                    >
                        {type}
                    </button>
                ))}
            </div>

            {/* Status indicator */}
            <div className="filter-status">
                {loading && <span>Loading...</span>}
                {error && <span className="error">{error}</span>}
                {!loading && !error && entityCount >= 0 && <span>{entityCount} entities in this book</span>}
                {!loading && !error && entityCount < 0 && <span>Book not indexed</span>}
            </div>
        </div>
    );
}
```

---

### Compare (View Multiple Entities)

**Purpose:** Compare entities side-by-side to understand distinctions

**Implementation Status:** Designed, not fully implemented

**Design Concept:**

```svelte
<div class="flow-compare-mode">
    <div class="entity-column" each entity in selectedEntities>
        <div class="entity-card">
            <h3>{entity.name}</h3>
            <p>{entity.description}</p>
            <div class="entity-relationships">
                {#each entity.relationships as rel}
                    <span class="relationship-badge">{rel.type} ‚Üí {rel.target}</span>
                {/each}
            </div>
        </div>
    </div>
</div>
```

**Use Cases:**
- Compare "Acceptance" vs "Resignation" (distinctions)
- Compare "Executive Function" across theories (Barkley vs Diamond)
- Compare "Shame" definitions from different sources

**Activation:**
- Select multiple entities via checkboxes
- Click "Compare" button
- Side-by-side view with highlighting of differences

---

### Pivot (Change Perspective)

**Purpose:** Navigate from current entity to related entity

**User Action:** Click entity chip in relationships panel

**Flow:**
```
1. User clicks related entity chip
   ‚Üì
2. Previous entity added to journey breadcrumb
   ‚Üì
3. New entity becomes currentEntity
   ‚Üì
4. Fetch new entity's relationships, sources, questions
   ‚Üì
5. Update journey path display
   ‚Üì
6. Generate fresh thinking partner questions
```

**Breadcrumb Tracking:**

```typescript
interface JourneyStep {
    entity: string;
    entityType: string;
    enteredAt: number;      // Timestamp
    exitedAt?: number;      // Timestamp when navigated away
    dwellTime?: number;     // Seconds spent on entity
    questionResponses?: Array<{
        question: string;
        response: string;
        timestamp: string;
    }>;
}

let journeyPath: JourneyStep[] = [];

function addJourneyStep(entity: string, entityType: string) {
    // Close previous step
    if (journeyPath.length > 0) {
        const lastStep = journeyPath[journeyPath.length - 1];
        lastStep.exitedAt = Date.now();
        lastStep.dwellTime = Math.floor((lastStep.exitedAt - lastStep.enteredAt) / 1000);
    }

    // Add new step
    journeyPath.push({
        entity,
        entityType,
        enteredAt: Date.now()
    });
}
```

**Readest Breadcrumb Visualization (JourneyBreadcrumb.tsx lines 1-98):**

```typescript
export function JourneyBreadcrumb({ journey, onStepClick }: Props) {
    const visibleSteps = journey.slice(-5);  // Show last 5 steps
    const overflowCount = journey.length - visibleSteps.length;

    return (
        <div className="journey-breadcrumb">
            <div className="journey-header">
                <LuRoute className="journey-icon" />
                <span>Journey</span>
                <span className="journey-marks-count">{journey.length} steps</span>
            </div>

            <div className="journey-path">
                {overflowCount > 0 && (
                    <div className="journey-overflow">+{overflowCount} more</div>
                )}

                {visibleSteps.map((step, index) => (
                    <div key={index} className="journey-step" onClick={() => onStepClick(step.entity)}>
                        <span className="step-entity">{step.entity}</span>
                        {step.dwellTime && (
                            <span className="step-dwell">
                                <LuClock /> {formatDwellTime(step.dwellTime)}
                            </span>
                        )}
                        {index < visibleSteps.length - 1 && (
                            <span className="step-arrow">‚Üí</span>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
}
```

---

## Thinking Partner Questions

**Purpose:** Deepen reflection at decision points without interrupting flow

**Question Generation:**

From FlowMode.svelte (lines 450-520):

```typescript
async function generateThinkingPartnerQuestions(entity: string, entityType: string, relationshipCount: number) {
    try {
        const questionsData = await apiPost('/question-engine/generate-questions', {
            approach: 'exploratory',
            topic: entity,
            context: {
                entity_type: entityType,
                relationship_count: relationshipCount,
                journey_length: journeyPath.length,
                dwell_time: getCurrentDwellTime()
            }
        });

        return questionsData.questions;
    } catch (err) {
        console.error('[FlowMode] Question generation error:', err);
        return [];
    }
}
```

**Question Classes in Flow Mode:**

Preferred classes for exploration:
- **Perspective-Shift** (üëÅÔ∏è) ‚Äî "How would X see this?"
- **Boundary** (üî≤) ‚Äî "What's NOT included?"
- **Dimensional** (üìê) ‚Äî "On a spectrum from X to Y?"
- **Schema-Probe** (üèóÔ∏è) ‚Äî "What are the main categories?"
- **Reflective-Synthesis** (üîó) ‚Äî "How do these pieces connect?"

**Interactive Q&A (Readest QuestionsSection.tsx lines 1-210):**

```typescript
export function QuestionsSection({ questions, onQuestionResponse, onBookmark }: Props) {
    const [expandedIndex, setExpandedIndex] = useState<number | null>(null);
    const [responses, setResponses] = useState<Record<number, string>>({});
    const [submitted, setSubmitted] = useState<Set<number>>(new Set());

    function handleSubmit(index: number) {
        const response = responses[index];
        if (!response?.trim()) return;

        onQuestionResponse(questions[index].question, response);
        setSubmitted(new Set([...submitted, index]));
        setResponses({ ...responses, [index]: '' });
    }

    return (
        <div className="flow-questions">
            <h3 className="flow-section-header">Thinking Partner Questions</h3>

            {questions.map((q, index) => (
                <div key={index} className="question-card">
                    <div className="question-header" onClick={() => setExpandedIndex(index === expandedIndex ? null : index)}>
                        <span className="question-type-badge" data-type={q.type}>{q.type}</span>
                        <span className="question-text">{q.question}</span>
                        <button className="question-bookmark" onClick={(e) => { e.stopPropagation(); onBookmark(q); }}>
                            <LuBookmark />
                        </button>
                    </div>

                    {expandedIndex === index && (
                        <div className="question-response">
                            {submitted.has(index) ? (
                                <div className="response-submitted">
                                    <p>Response recorded in journey</p>
                                </div>
                            ) : (
                                <>
                                    <textarea
                                        value={responses[index] || ''}
                                        onChange={(e) => setResponses({ ...responses, [index]: e.target.value })}
                                        placeholder="Type your response..."
                                        onKeyDown={(e) => {
                                            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                                                handleSubmit(index);
                                            }
                                        }}
                                    />
                                    <button onClick={() => handleSubmit(index)}>
                                        Submit (Cmd/Ctrl+Enter)
                                    </button>
                                </>
                            )}
                        </div>
                    )}
                </div>
            ))}
        </div>
    );
}
```

**Question Response Tracking:**

```typescript
function handleQuestionResponse(question: string, response: string) {
    // Add to current journey step
    const currentStep = journeyPath[journeyPath.length - 1];
    if (!currentStep.questionResponses) {
        currentStep.questionResponses = [];
    }
    currentStep.questionResponses.push({
        question,
        response,
        timestamp: new Date().toISOString()
    });

    // Record in breadcrumb for journey synthesis
    addJourneyMark({
        type: 'question_response',
        content: `Q: ${question}\nA: ${response}`,
        timestamp: new Date().toISOString()
    });
}
```

---

## Journey Synthesis

**Purpose:** AI-generated summary of insights from exploration path

**Trigger Points:**
- User clicks "Synthesize Journey" button
- Session ends (auto-synthesis)
- Journey reaches 10+ steps (suggested synthesis)

**Backend Endpoint:**

```
POST /flow/{session_id}/synthesize
```

**Request:**

```json
{
    "journey_path": [
        {
            "entity": "Executive Function",
            "dwell_time": 45,
            "question_responses": [
                {
                    "question": "What are the main components?",
                    "response": "Working memory, inhibition, cognitive flexibility"
                }
            ]
        },
        {
            "entity": "Working Memory",
            "dwell_time": 30
        }
    ]
}
```

**Response (from FlowSessionService):**

```json
{
    "synthesis": "Your exploration focused on executive function mechanisms, with particular attention to working memory's role. You noted the connection between inhibition and cognitive flexibility, suggesting an integrated system rather than isolated components. The journey revealed that executive function emerges from coordinated subsystems.",
    "key_entities": ["Executive Function", "Working Memory", "Inhibition"],
    "suggested_next_steps": [
        "Explore how these components interact in ADHD",
        "Compare Barkley's model with Diamond's framework",
        "Investigate developmental trajectory of executive functions"
    ]
}
```

**UI Display (FlowMode.svelte lines 850-920):**

```svelte
{#if showSynthesis && synthesis}
    <div class="flow-synthesis-panel">
        <h3>Journey Synthesis</h3>

        <div class="synthesis-content">
            <p>{synthesis.synthesis}</p>
        </div>

        <div class="synthesis-entities">
            <h4>Key Concepts Explored:</h4>
            <div class="entity-chips">
                {#each synthesis.key_entities as entity}
                    <span class="entity-chip" on:click={() => handleEntityClick(entity)}>{entity}</span>
                {/each}
            </div>
        </div>

        <div class="synthesis-next-steps">
            <h4>Suggested Next Steps:</h4>
            <ul>
                {#each synthesis.suggested_next_steps as step}
                    <li>{step}</li>
                {/each}
            </ul>
        </div>

        <div class="synthesis-actions">
            <button on:click={handleSaveSynthesis}>Save as Insight</button>
            <button on:click={handleCreateSession}>Start Dialogue Session</button>
        </div>
    </div>
{/if}
```

---

## Multi-Entry Points (Origin Types)

From `flow_session.py` schema (lines 14-22):

```python
class FlowOriginType(str, Enum):
    """Origin types for flow sessions."""

    THINKING_SESSION_NOTE = "thinking-session-note"  # From completed dialogue
    SPARK = "spark"                                  # From personal graph spark
    CONCEPT = "concept"                              # From domain concept search
    DASHBOARD_SUGGESTION = "dashboard-suggestion"    # From suggestion API
    ENTITY_CLICK = "entity-click"                    # From entity overlay in Readest
```

### Flow from Thinking Session

```
ThinkingSession (completed)
  ‚Üí User clicks entity in session results
  ‚Üí POST /flow/open-from-session { session_id, entity_id }
  ‚Üí FlowSession created with origin: THINKING_SESSION_NOTE
  ‚Üí Flow opens with entity + session context
```

**Benefits:**
- Journey starts with pre-loaded context from dialogue
- Questions can reference session insights
- Synthesis can compare dialogue vs. exploration insights

### Flow from Spark

```
Spark (status: captured)
  ‚Üí User clicks "Explore" on spark card
  ‚Üí POST /flow/open-from-spark { spark_id }
  ‚Üí FlowSession created with origin: SPARK
  ‚Üí Flow opens with spark content as initial context
```

**Benefits:**
- Low-friction exploration from ephemeral captures
- Spark resonance signal informs question generation
- Energy level determines recommended depth

### Flow from Concept Search

```
Dashboard search bar
  ‚Üí User types concept name ‚Üí selects result
  ‚Üí POST /flow/open-from-concept { concept_name }
  ‚Üí FlowSession created with origin: CONCEPT
  ‚Üí Flow opens with concept details
```

**Benefits:**
- Direct access to canonical concepts
- Relationships immediately visible
- Sources pre-loaded for reference

### Flow from Entity Overlay (Readest)

```
Reading book in Readest
  ‚Üí User clicks highlighted entity
  ‚Üí Flow panel opens (side-by-side with text)
  ‚Üí GET /graph/entity?name={entityName}
  ‚Üí Display entity details + relationships
  ‚Üí Journey tracking begins
```

**Benefits:**
- Seamless reading ‚Üí exploration transition
- Context preserved (book, chapter, page)
- Return to reading without losing place

**Implementation (useEntityClick.ts lines 1-88):**

```typescript
export function useEntityClick(onEntityClick: (entityName: string) => void) {
    useEffect(() => {
        function handleEntityClickEvent(event: CustomEvent) {
            const { entityName } = event.detail;

            // Open Flow panel
            onEntityClick(entityName);

            // Fetch entity data
            // ... (see entity click implementation)
        }

        // Listen for entity-click events from iframe content
        window.addEventListener('entity-click', handleEntityClickEvent as EventListener);

        return () => {
            window.removeEventListener('entity-click', handleEntityClickEvent as EventListener);
        };
    }, [onEntityClick]);
}
```

---

## Backend API Integration

**Flow Mode APIs:**

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/flow/open-from-session` | POST | Create flow from thinking session |
| `/flow/open-from-spark` | POST | Create flow from spark |
| `/flow/open-from-concept` | POST | Create flow from concept search |
| `/flow/{session_id}/step` | POST | Record breadcrumb during exploration |
| `/flow/{session_id}/synthesize` | POST | Generate journey synthesis |
| `/graph/entity` | GET | Fetch entity details |
| `/graph/relationships` | GET | Fetch entity relationships |
| `/graph/sources` | GET | Fetch source books/chapters |
| `/graph/entities/by-book/{hash}` | GET | Entities in specific book |
| `/graph/entities/by-calibre-id/{id}` | GET | Entities by Calibre book ID |
| `/reframes/{concept_id}` | GET | Fetch concept reframes |

**FlowSession Lifecycle:**

```typescript
// 1. Open flow session
const flowSession = await apiPost('/flow/open-from-concept', {
    concept_name: 'Executive Function'
});

// 2. Track exploration steps
await apiPost(`/flow/${flowSession.session_id}/step`, {
    entity_visited: 'Working Memory',
    dwell_time: 45,
    question_responses: [...]
});

// 3. Generate synthesis
const synthesis = await apiPost(`/flow/${flowSession.session_id}/synthesize`, {
    journey_path: journeyPath
});

// 4. Save insights
await apiPost('/personal/insights', {
    title: 'EF Components Connection',
    content: synthesis.synthesis,
    source_flow_session_id: flowSession.session_id
});
```

---

## Implementation Status

| Component | File | Status | Lines | Notes |
|-----------|------|--------|-------|-------|
| **Frontend (SiYuan)** | | | | |
| FlowMode UI | `FlowMode.svelte` | ‚úÖ Complete | 1516 | Search, relationships, questions |
| Journey Tracking | `siyuan-structure.ts` | ‚úÖ Complete | 769 | Breadcrumb persistence |
| **Frontend (Readest)** | | | | |
| Flow Panel Container | `FlowPanel.tsx` | ‚úÖ Complete | 197 | Main panel component |
| Entity Section | `EntitySection.tsx` | ‚úÖ Complete | 53 | Entity display |
| Relationships Section | `RelationshipsSection.tsx` | ‚úÖ Complete | 104 | Grouped relationships |
| Sources Section | `SourcesSection.tsx` | ‚úÖ Complete | 65 | Book sources |
| Questions Section | `QuestionsSection.tsx` | ‚úÖ Complete | 210 | Interactive Q&A |
| Reframes Section | `ReframesSection.tsx` | ‚úÖ Complete | TBD | Metaphors/analogies |
| Journey Breadcrumb | `JourneyBreadcrumb.tsx` | ‚úÖ Complete | 98 | Path visualization |
| Entity Type Filter | `EntityTypeFilter.tsx` | ‚úÖ Complete | 122 | Pill-based UI |
| Entity Click Handler | `useEntityClick.ts` | ‚úÖ Complete | 88 | Event listener hook |
| Flow State | `flowModeStore.ts` | ‚úÖ Complete | 380+ | Zustand state management |
| **Backend** | | | | |
| Flow API | `api/flow_session.py` | ‚úÖ Complete | TBD | Session lifecycle |
| Flow Service | `services/flow_session_service.py` | ‚úÖ Complete | 342 | Journey synthesis |
| Graph API | `api/graph.py` | ‚úÖ Complete | TBD | Entity/relationship queries |
| Graph Service | `services/graph_service.py` | ‚úÖ Complete | TBD | Neo4j integration |
| Reframe API | `api/reframe.py` | ‚úÖ Complete | 55 | Concept reframes |
| **Tests** | | | | |
| Backend Tests | `tests/test_*.py` | ‚úÖ Passing | TBD | 94/94 tests passing |

---

## Integration with Other Modes

### Dialogue ‚Üí Flow

```
ThinkingSession (completed)
  ‚Üí User clicks entity in results
  ‚Üí POST /flow/open-from-session { session_id, entity_id }
  ‚Üí FlowSession created with session context
  ‚Üí Flow opens with entity as starting point
  ‚Üí Journey synthesis can compare dialogue insights vs. exploration discoveries
```

**Data Passed:**
- `session.entities` ‚Üí Extracted concepts
- `session.breadcrumbs` ‚Üí Dialogue journey for context
- `session.id` ‚Üí Source reference

### Flow ‚Üí Capture

```
FlowSession (exploring)
  ‚Üí User encounters unexpected connection
  ‚Üí Clicks "Quick Capture" button
  ‚Üí Spark created with current entity as context
  ‚Üí Spark status: raw
  ‚Üí User can continue exploring, process spark later
```

**Data Passed:**
- `current_entity` ‚Üí Context for spark
- `journey_path` ‚Üí Exploration breadcrumb for reference
- `flow_session_id` ‚Üí Source reference

### Flow ‚Üí Dialogue

```
FlowSession (synthesis generated)
  ‚Üí User clicks "Start Dialogue Session"
  ‚Üí POST /thinking/start { flow_session_id, synthesis_as_topic }
  ‚Üí ThinkingSession created with synthesis as initial context
  ‚Üí ForgeMode opens with pre-loaded insights from exploration
```

**Data Passed:**
- `synthesis.key_entities` ‚Üí Initial entities for dialogue
- `synthesis.suggested_next_steps` ‚Üí Potential dialogue angles
- `flow_session.id` ‚Üí Source reference

---

## Key Differentiators

| Traditional Graph Viewers | IES Flow Mode |
|---------------------------|---------------|
| Static node-link diagrams | User-driven navigation with thinking partner |
| All relationships shown at once | Grouped by type, collapsible |
| No guidance on what to explore | AI questions at decision points |
| Isolated browsing | Journey tracking with breadcrumbs |
| No synthesis | AI-generated insights from path |
| One entry point | 5 origin types (session, spark, concept, dashboard, entity click) |

---

## References

**Implementation Files (SiYuan):**
- FlowMode: `.worktrees/siyuan/ies/plugin/src/views/FlowMode.svelte`
- Structure: `.worktrees/siyuan/ies/plugin/src/utils/siyuan-structure.ts`

**Implementation Files (Readest):**
- Flow Panel: `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/FlowPanel.tsx`
- Entity Section: `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/EntitySection.tsx`
- Relationships: `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/RelationshipsSection.tsx`
- Sources: `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/SourcesSection.tsx`
- Questions: `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/QuestionsSection.tsx`
- Breadcrumb: `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/flowpanel/JourneyBreadcrumb.tsx`
- Filter: `.worktrees/readest/readest/apps/readest-app/src/app/reader/components/EntityTypeFilter.tsx`
- Entity Click: `.worktrees/readest/readest/apps/readest-app/src/app/reader/hooks/useEntityClick.ts`
- State: `.worktrees/readest/readest/apps/readest-app/src/store/flowModeStore.ts`

**Backend:**
- Flow API: `ies/backend/src/ies_backend/api/flow_session.py`
- Flow Service: `ies/backend/src/ies_backend/services/flow_session_service.py`
- Graph Service: `ies/backend/src/ies_backend/services/graph_service.py`
- Flow Schemas: `ies/backend/src/ies_backend/schemas/flow_session.py`

**Related Docs:**
- `docs/ies-master-analysis/0-system/0.1-IES-Overview.md` ‚Äî System overview and knowledge lifecycle
- `docs/ies-master-analysis/2-modes/2.1-Capture-Spec.md` ‚Äî Capture Mode specification
- `docs/ies-master-analysis/2-modes/2.2-Dialogue-Spec.md` ‚Äî Dialogue Mode specification
- `docs/ies-master-analysis/2-modes/2.4-Mode-Transition-Engine.md` ‚Äî Mode switching logic

---

*This document defines Flow Mode‚Äîthe visual graph exploration system in IES. For ephemeral capture, see 2.1-Capture-Spec.md. For structured thinking, see 2.2-Dialogue-Spec.md.*
